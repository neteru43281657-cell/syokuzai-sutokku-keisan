<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ¥é€±ã®é£Ÿæã‚¹ãƒˆãƒƒã‚¯è¨ˆç®—</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#111111">

  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#666; --line:#e6e8f0; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; background:var(--bg); color:var(--text); }
    header { padding:14px 16px; font-weight:800; background:#111; color:#fff; position:sticky; top:0; z-index:5; }
    main { max-width: 980px; margin: 0 auto; padding: 12px; display:flex; flex-direction:column; gap: 12px; }

    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .col { display:flex; flex-direction:column; gap:8px; }

    label { font-size: 13px; color: var(--muted); }
    select, input[type="number"] { padding:10px; border:1px solid var(--line); border-radius:12px; font-size:14px; background:#fff; }
    button { padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff; font-weight:700; cursor:pointer; }
    button.primary { background:#111; color:#fff; border-color:#111; }
    button.danger { background:#fff; color:#b00020; border-color:#f0c2c7; }

    .small { font-size:12px; color:var(--muted); }
    .divider { height:1px; background:var(--line); margin:10px 0; }

    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
    .ing { display:flex; justify-content:space-between; gap:10px; padding:10px; border:1px solid var(--line); border-radius:12px; background:#fff; }
    .ing .left { display:flex; gap:8px; align-items:center; }
    .qty { font-weight:800; }

    .recipeRow { border:1px dashed var(--line); border-radius:14px; padding:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .recipeRow > * { flex: 0 0 auto; }
    .recipeRow select.recipeSel { min-width: 280px; }
    .rightGrow { flex: 1 1 auto; }

    .suffix { color:var(--muted); font-size:13px; margin-left:6px; }
    .stat { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge { font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); background:#fff; }
  </style>
</head>

<body>
<header>æ¥é€±ã®é£Ÿæã‚¹ãƒˆãƒƒã‚¯è¨ˆç®—</header>

<main>
  <!-- æ¡ä»¶ -->
  <section class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-start;">
      <div>
        <div style="font-weight:800; font-size:16px;">æ¡ä»¶</div>
        <div class="stat" style="margin-top:6px;">
          <span class="badge">1æ—¥=3é£Ÿ</span>
          <span class="badge" id="summaryBadge">åˆè¨ˆ 0é£Ÿï¼ˆ0æ—¥æ›ç®—ï¼‰</span>
        </div>
      </div>

      <div class="col" style="min-width:160px;">
        <button id="addRecipe" class="primary">æ–™ç†ã‚’è¿½åŠ </button>
        <button id="clearAll" class="danger">å…¨éƒ¨ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <div style="margin-top:10px;" id="recipeList"></div>
  </section>

  <!-- é™¤å¤– -->
  <section class="card">
    <div style="font-weight:800; font-size:16px;">ä»¥ä¸‹ã®é£Ÿæã¯è¨ˆç®—ã‹ã‚‰é™¤å¤–ã™ã‚‹</div>
    <div class="grid" id="excludeGrid" style="margin-top:10px;"></div>
  </section>

  <!-- è£œå®Œ -->
  <section class="card">
    <div style="font-weight:800; font-size:16px;">ä»¥ä¸‹ã®é£Ÿæã¯1æ—¥å½“ãŸã‚Šnå€‹è£œå®Œå¯èƒ½ã¨ä»®å®šã™ã‚‹</div>
    <div class="grid" id="replenishGrid" style="margin-top:10px;"></div>
  </section>

  <!-- çµæœ -->
  <section class="card">
    <div style="font-weight:800; font-size:16px;">è¨ˆç®—çµæœ</div>
    <div class="divider"></div>
    <div id="resultGrid" class="grid"></div>
  </section>
</main>

<script>
/**
 * ä»•æ§˜ï¼ˆæ ¹å¹¹ï¼‰
 * - 1æ—¥=3é£Ÿ
 * - è¡Œã”ã¨ã®ã€Œâ—é£Ÿã€ã¯ã€ãã®æ–™ç†ã‚’ä½•é£Ÿä½œã‚‹ã‹
 * - æ—¥æ•° = åˆè¨ˆé£Ÿæ•° / 3ï¼ˆå°æ•°OKï¼‰
 * - è£œå®Œï¼ˆnå€‹/æ—¥ï¼‰ã¯ã€ï¼ˆn Ã— æ—¥æ•°ï¼‰ã‚’å¿…è¦é‡ã‹ã‚‰æ¸›ç®—
 * - é™¤å¤–ãƒã‚§ãƒƒã‚¯ã®é£Ÿæã¯ 0 æ‰±ã„
 */

const MEALS_PER_DAY = 3;

// é£Ÿæï¼ˆ19ç¨®ï¼šå¿…è¦ã«å¿œã˜ã¦ id/åç§°/ã‚¢ã‚¤ã‚³ãƒ³ã‚’å·®ã—æ›¿ãˆOKï¼‰
const INGREDIENTS = [
  {id:"apple", name:"ã¨ãã›ã‚“ãƒªãƒ³ã‚´", icon:"ğŸ"},
  {id:"honey", name:"ã‚ã¾ã„ãƒŸãƒ„", icon:"ğŸ¯"},
  {id:"milk", name:"ãƒ¢ãƒ¼ãƒ¢ãƒ¼ãƒŸãƒ«ã‚¯", icon:"ğŸ¥›"},
  {id:"oil", name:"ãƒ”ãƒ¥ã‚¢ãªã‚ªã‚¤ãƒ«", icon:"ğŸ›¢ï¸"},
  {id:"potato", name:"ã»ã£ã“ã‚Šãƒãƒ†ãƒˆ", icon:"ğŸ¥”"},
  {id:"avocado", name:"ã¤ã‚„ã¤ã‚„ã‚¢ãƒœã‚«ãƒ‰", icon:"ğŸ¥‘"},
  {id:"tomato", name:"ã‚ã‚“ã¿ã‚“ãƒˆãƒãƒˆ", icon:"ğŸ…"},
  {id:"ginger", name:"ã²ã‚“ã‚„ã‚Šã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼", icon:"ğŸ«š"},
  {id:"corn", name:"ãƒ¯ã‚«ã‚¯ã‚µã‚³ãƒ¼ãƒ³", icon:"ğŸŒ½"},
  {id:"cacao", name:"ãƒªãƒ©ãƒƒã‚¯ã‚¹ã‚«ã‚«ã‚ª", icon:"ğŸ«"},
  {id:"egg", name:"ã¨ãã›ã‚“ã‚¨ãƒƒã‚°", icon:"ğŸ¥š"},
  {id:"soymeat", name:"ãƒãƒ¡ãƒŸãƒ¼ãƒˆ", icon:"ğŸ«˜"},
  {id:"mushroom", name:"ã‚ã˜ã‚ã„ã‚­ãƒã‚³", icon:"ğŸ„"},
  {id:"leek", name:"ãµã¨ã„ãªãŒã­ã", icon:"ğŸ§…"},
  {id:"sausage", name:"ã’ã‚“ãã‚½ãƒ¼ã‚»ãƒ¼ã‚¸", icon:"ğŸŒ­"},
  {id:"soy", name:"ãƒ¯ã‚«ã‚¯ã‚µå¤§è±†", icon:"ğŸ«˜"},
  {id:"herb", name:"ã‚ã–ã¾ã—ãƒãƒ¼ãƒ–", icon:"ğŸŒ¿"},
  {id:"tail", name:"ãŠãŠãã„ã—ã£ã½", icon:"ğŸŸ"},
  {id:"coffee", name:"ã‚¹ãƒ‘ãƒ¼ã‚¯ã‚¹ã‚³ãƒ¼ãƒ’ãƒ¼", icon:"â˜•"},
];

// ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ã‚·ãƒ”ï¼ˆå¾Œã§å¢—ã‚„ã™å‰æï¼‰
const RECIPES = [
  {
    id:"shiny_avocado_gratin",
    category:"curry",
    name:"ã—ã‚“ã‚Šã‚‡ãã‚¢ãƒœã‚«ãƒ‰ã‚°ãƒ©ã‚¿ãƒ³",
    ingredients: { avocado:22, potato:20, milk:41, oil:32 }
  },
  {
    id:"simple_curry",
    category:"curry",
    name:"ã‚·ãƒ³ãƒ—ãƒ«ã‚«ãƒ¬ãƒ¼ï¼ˆä¾‹ï¼‰",
    ingredients: { tomato:10, oil:8, sausage:12 }
  },
  {
    id:"potato_salad",
    category:"salad",
    name:"ãƒãƒ†ãƒˆã‚µãƒ©ãƒ€ï¼ˆä¾‹ï¼‰",
    ingredients: { potato:18, egg:10, oil:6 }
  },
  {
    id:"honey_drink",
    category:"dessert",
    name:"ã¯ã¡ã¿ã¤ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆä¾‹ï¼‰",
    ingredients: { honey:16, milk:14, cacao:6 }
  }
];

const CATEGORY_LABEL = {
  curry: "ã‚«ãƒ¬ãƒ¼ãƒ»ã‚·ãƒãƒ¥ãƒ¼",
  salad: "ã‚µãƒ©ãƒ€",
  dessert: "ãƒ‡ã‚¶ãƒ¼ãƒˆãƒ»ãƒ‰ãƒªãƒ³ã‚¯"
};

const el = (id) => document.getElementById(id);

const state = {
  recipeRows: [] // {rowId, recipeId, meals}
};

function recipeOptionsHTML() {
  // ã€Œæ–™ç†ã‚’é¸æŠâ€¦ã€ã¯å‡ºã•ãªã„ï¼ˆè¦æœ›å¯¾å¿œï¼‰
  const groups = {
    curry: RECIPES.filter(r => r.category === "curry"),
    salad: RECIPES.filter(r => r.category === "salad"),
    dessert: RECIPES.filter(r => r.category === "dessert"),
  };

  let html = "";
  for (const key of ["curry","salad","dessert"]) {
    const list = groups[key];
    if (!list.length) continue;
    html += `<optgroup label="${CATEGORY_LABEL[key]}">`;
    for (const r of list) html += `<option value="${r.id}">${r.name}</option>`;
    html += `</optgroup>`;
  }
  return html;
}

function addRecipeRow(initial) {
  const rowId = crypto.randomUUID();
  const defaultRecipeId = RECIPES[0]?.id ?? "";
  const row = {
    rowId,
    recipeId: initial?.recipeId ?? defaultRecipeId,
    meals: initial?.meals ?? 1
  };
  state.recipeRows.push(row);

  const wrap = document.createElement("div");
  wrap.className = "recipeRow";
  wrap.dataset.rowId = rowId;

  wrap.innerHTML = `
    <div>
      <label>æ–™ç†</label><br>
      <select class="recipeSel">${recipeOptionsHTML()}</select>
    </div>

    <div>
      <label>ä½•é£Ÿä½œã‚Šã¾ã™ã‹ï¼Ÿ</label><br>
      <select class="mealsSel">
        ${Array.from({length:21}, (_,i)=>`<option value="${i+1}">${i+1}</option>`).join("")}
      </select>
      <span class="suffix">é£Ÿ</span>
    </div>

    <div class="rightGrow small preview"></div>
  `;

  const recipeSel = wrap.querySelector(".recipeSel");
  const mealsSel = wrap.querySelector(".mealsSel");
  const preview = wrap.querySelector(".preview");

  recipeSel.value = row.recipeId;
  mealsSel.value = String(row.meals);

  function renderPreview() {
    const rid = recipeSel.value;
    const r = RECIPES.find(x => x.id === rid);
    if (!r) { preview.textContent = ""; return; }
    const parts = Object.entries(r.ingredients).map(([iid, q]) => {
      const ing = INGREDIENTS.find(i=>i.id===iid);
      return `${ing?.icon ?? "â– "}${q}`;
    });
    preview.textContent = parts.length ? `ææ–™: ${parts.join(" / ")}` : "";
  }
  renderPreview();

  recipeSel.addEventListener("change", () => {
    const s = state.recipeRows.find(x => x.rowId === rowId);
    s.recipeId = recipeSel.value;
    renderPreview();
    scheduleCalc();
  });

  mealsSel.addEventListener("change", () => {
    const s = state.recipeRows.find(x => x.rowId === rowId);
    s.meals = Number(mealsSel.value);
    scheduleCalc();
  });

  el("recipeList").appendChild(wrap);
}

function renderExcludeAndReplenish() {
  const ex = el("excludeGrid");
  const rep = el("replenishGrid");
  ex.innerHTML = "";
  rep.innerHTML = "";

  for (const ing of INGREDIENTS) {
    // é™¤å¤–ï¼ˆå³å´ãƒ©ãƒ™ãƒ«å‰Šé™¤ï¼‰
    const exItem = document.createElement("div");
    exItem.className = "ing";
    exItem.innerHTML = `
      <div class="left">
        <input type="checkbox" class="exChk" data-iid="${ing.id}">
        <div>${ing.icon} ${ing.name}</div>
      </div>
    `;
    ex.appendChild(exItem);

    // è£œå®Œï¼ˆã€Œ1æ—¥ã‚ãŸã‚Šã€è¡¨ç¤ºå‰Šé™¤ã€"å€‹"ã¯ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰
    const repItem = document.createElement("div");
    repItem.className = "ing";
    repItem.innerHTML = `
      <div class="left">
        <input type="checkbox" class="repChk" data-iid="${ing.id}">
        <div>${ing.icon} ${ing.name}</div>
      </div>
      <div class="row" style="gap:6px;">
        <input type="number" class="repQty" data-iid="${ing.id}" min="0" max="999" value="0" style="width:92px;">
        <span class="suffix">å€‹</span>
      </div>
    `;
    rep.appendChild(repItem);
  }

  // å¤‰æ›´ã®ãŸã³ã«å³åæ˜ 
  document.querySelectorAll(".exChk").forEach(x => x.addEventListener("change", scheduleCalc));
  document.querySelectorAll(".repChk").forEach(x => x.addEventListener("change", scheduleCalc));
  document.querySelectorAll(".repQty").forEach(x => x.addEventListener("input", scheduleCalc));
}

function readExcludeSet() {
  const set = new Set();
  document.querySelectorAll(".exChk:checked").forEach(chk => set.add(chk.dataset.iid));
  return set;
}

function readReplenishMap() {
  const map = new Map(); // iid -> perDay
  document.querySelectorAll(".repChk:checked").forEach(chk => {
    const iid = chk.dataset.iid;
    const qtyInput = document.querySelector(`.repQty[data-iid="${iid}"]`);
    const perDay = Math.max(0, Math.min(999, Number(qtyInput.value || 0)));
    map.set(iid, perDay);
  });
  return map;
}

// å³æ™‚åæ˜ ç”¨ï¼ˆé€£æ‰“ã—ã¦ã‚‚è»½ãã™ã‚‹ï¼‰
let calcTimer = null;
function scheduleCalc() {
  if (calcTimer) return;
  calcTimer = setTimeout(() => {
    calcTimer = null;
    calc();
  }, 0);
}

function calc() {
  const exclude = readExcludeSet();
  const replenish = readReplenishMap();

  // åˆè¨ˆé£Ÿæ•°
  let totalMeals = 0;
  for (const row of state.recipeRows) totalMeals += Number(row.meals || 0);

  // æ—¥æ•°ï¼ˆå°æ•°OKï¼‰
  const days = totalMeals / MEALS_PER_DAY;

  // åˆè¨ˆå¿…è¦æ•°ï¼ˆæ¸›ç®—å‰ï¼‰
  const need = new Map(); // iid -> total
  for (const row of state.recipeRows) {
    const recipe = RECIPES.find(r => r.id === row.recipeId);
    if (!recipe) continue;
    const meals = Math.max(0, Math.min(21, Number(row.meals || 0)));

    for (const [iid, perMeal] of Object.entries(recipe.ingredients)) {
      need.set(iid, (need.get(iid) || 0) + perMeal * meals);
    }
  }

  // é™¤å¤–
  for (const iid of exclude) need.set(iid, 0);

  // è£œå®Œï¼ˆn Ã— æ—¥æ•°ï¼‰
  for (const [iid, perDay] of replenish.entries()) {
    const prev = need.get(iid) || 0;
    const next = prev - perDay * days;
    need.set(iid, Math.max(0, next));
  }

  // è¡¨ç¤ºï¼ˆå¤šã„é †ï¼‰
  const list = INGREDIENTS.map(ing => ({
    ...ing,
    total: need.get(ing.id) || 0
  }))
    .filter(x => x.total > 0)
    .sort((a,b) => b.total - a.total);

  // ç«¯æ•°ã¯å››æ¨äº”å…¥ï¼ˆå°æ•°æ—¥ãŒã‚ã‚Šå¾—ã‚‹ãŸã‚ï¼‰
  // â€»åˆ‡ã‚Šä¸Šã’é‹ç”¨ã«ã—ãŸã‘ã‚Œã° Math.ceil ã«å¤‰æ›´å¯èƒ½
  for (const x of list) x.total = Math.round(x.total);

  // ã‚µãƒãƒªãƒ¼
  el("summaryBadge").textContent = `åˆè¨ˆ ${totalMeals}é£Ÿï¼ˆ${(Math.round(days*100)/100)}æ—¥æ›ç®—ï¼‰`;

  // çµæœ
  const out = el("resultGrid");
  out.innerHTML = "";
  if (!list.length) {
    out.innerHTML = `<div class="small">ï¼ˆå¿…è¦ã‚¹ãƒˆãƒƒã‚¯ãŒ0ã§ã™ï¼‰</div>`;
    return;
  }

  for (const x of list) {
    const item = document.createElement("div");
    item.className = "ing";
    item.innerHTML = `
      <div class="left">
        <div style="font-size:22px;">${x.icon}</div>
        <div>${x.name}</div>
      </div>
      <div class="qty">${x.total}å€‹</div>
    `;
    out.appendChild(item);
  }
}

// ãƒœã‚¿ãƒ³
el("addRecipe").addEventListener("click", () => { addRecipeRow(); scheduleCalc(); });
el("clearAll").addEventListener("click", () => {
  // è¡Œã¨ãƒã‚§ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ
  state.recipeRows = [];
  el("recipeList").innerHTML = "";

  document.querySelectorAll("input[type=checkbox]").forEach(x => x.checked = false);
  document.querySelectorAll(".repQty").forEach(x => x.value = "0");

  // 1è¡Œã ã‘å¾©æ´»
  addRecipeRow({ recipeId: RECIPES[0]?.id ?? "", meals: 1 });
  scheduleCalc();
});

// init
renderExcludeAndReplenish();
addRecipeRow({ recipeId: "shiny_avocado_gratin", meals: 12 });
scheduleCalc();
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js");
  });
}
</script>

</body>
</html>
