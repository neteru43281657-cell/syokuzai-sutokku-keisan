<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>食材ストック計算</title>
  <style>
    :root { --bg: #f6f7fb; --card: #fff; --text: #111; --muted: #666; --line: #e6e8f0; --danger: #b00020; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.4; }
    header { padding: 12px 14px; font-weight: 800; background: #111; color: #fff; position: sticky; top: 0; z-index: 5; }
    main { max-width: 980px; margin: 0 auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .grid4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    label { font-size: 11px; color: var(--muted); display: block; margin-bottom: 2px; }
    select, input[type="number"] { padding: 6px; border: 1px solid var(--line); border-radius: 10px; font-size: 14px; width: 100%; background: #fff; }
    button { padding: 8px 12px; border: 1px solid var(--line); border-radius: 10px; background: #fff; font-weight: 800; cursor: pointer; font-size: 13px; }
    button.primary { background: #111; color: #fff; }
    button.danger { color: var(--danger); border-color: #f0c2c7; }
    button:disabled { opacity: 0.5; }
    .badge { font-size: 11px; padding: 3px 8px; border-radius: 999px; border: 1px solid var(--line); color: var(--muted); background: #fff; }
    .divider { height: 1px; background: var(--line); margin: 8px 0; }
    .tile { border: 1px solid var(--line); border-radius: 10px; padding: 6px; display: flex; flex-direction: column; gap: 4px; background: #fff; align-items: center; text-align: center; position: relative; }
    .icon { width: 32px; height: 32px; object-fit: contain; }
    .tileName { font-size: 10px; font-weight: 800; height: 2.4em; display: flex; align-items: center; justify-content: center; line-height: 1.2; }
    .chkLabel { display: flex; align-items: center; gap: 3px; font-size: 10px; cursor: pointer; color: var(--muted); }
    .repQty { padding: 2px; font-size: 11px; text-align: center; border: 1px solid var(--line); border-radius: 4px; width: 100%; }
    .recipeRow { border: 1px dashed var(--line); border-radius: 12px; padding: 10px; display: flex; gap: 8px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 8px; position: relative; background: #fafbfc; }
    .removeBtn { position: absolute; top: 5px; right: 5px; border: none; background: none; color: var(--danger); font-size: 18px; cursor: pointer; }
    .preview { font-size: 11px; display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; border-top: 1px solid #eee; padding-top: 6px; width: 100%; }
    .preview span { display: flex; align-items: center; background: #eee; padding: 2px 6px; border-radius: 6px; }
    @media (max-width: 360px) { .grid4 { gap: 4px; } }
  </style>
</head>
<body>

<header>食材ストック計算</header>

<main>
  <section class="card">
    <div class="row" style="justify-content: space-between;">
      <div style="font-weight:900; font-size:14px;">条件 <span class="badge" id="summaryBadge">合計 0食</span></div>
      <div class="row">
        <button id="addRecipe" class="primary">+ 追加</button>
        <button id="clearAll" class="danger">クリア</button>
      </div>
    </div>
    <div id="recipeList" style="margin-top:8px;"></div>
  </section>

  <section class="card">
    <div style="font-weight:900; font-size:13px; margin-bottom:8px;">食材設定（除外・補完量）</div>
    <div id="ingGrid" class="grid4"></div>
  </section>

  <section class="card">
    <div class="row" style="justify-content: space-between;">
      <div style="font-weight:900; font-size:14px;">計算結果（必要数）</div>
      <span class="badge" id="totalBadge" style="color:#111; font-weight:800;">総合計 0個</span>
    </div>
    <div class="divider"></div>
    <div id="resultGrid" class="grid4"></div>
  </section>
</main>

<script>
const MEALS_PER_DAY = 3;
const MAX_TOTAL_MEALS = 21;

const INGREDIENTS = [
  { id:"leek", name:"ふといながねぎ", file:"ふといながねぎ.webp" },
  { id:"mushroom", name:"あじわいキノコ", file:"あじわいキノコ.webp" },
  { id:"egg", name:"とくせんエッグ", file:"とくせんエッグ.webp" },
  { id:"potato", name:"ほっこりポテト", file:"ほっこりポテト.webp" },
  { id:"apple", name:"とくせんリンゴ", file:"とくせんリンゴ.webp" },
  { id:"herb", name:"げきからハーブ", file:"げきからハーブ.webp" },
  { id:"soymeat", name:"マメミート", file:"マメミート.webp" },
  { id:"milk", name:"モーモーミルク", file:"モーモーミルク.webp" },
  { id:"honey", name:"あまいミツ", file:"あまいミツ.webp" },
  { id:"oil", name:"ピュアなオイル", file:"ピュアなオイル.webp" },
  { id:"ginger", name:"あったかジンジャー", file:"あったかジンジャー.webp" },
  { id:"tomato", name:"あんみんトマト", file:"あんみんトマト.webp" },
  { id:"cacao", name:"リラックスカカオ", file:"リラックスカカオ.webp" },
  { id:"tail", name:"おいしいシッポ", file:"おいしいシッポ.webp" },
  { id:"soy", name:"ワカクサ大豆", file:"ワカクサ大豆.webp" },
  { id:"corn", name:"ワカクサコーン", file:"ワカクサコーン.webp" },
  { id:"coffee", name:"めざましコーヒー", file:"めざましコーヒー.webp" },
  { id:"pumpkin", name:"ずっしりカボチャ", file:"ずっしりカボチャ.webp" },
  { id:"avocado", name:"つやつやアボカド", file:"つやつやアボカド.webp" }
];

const RECIPES = [
  { cat:"カレー", id:"avocado_gratin", name:"しんりょくアボカドグラタン", ingredients: { avocado:22, potato:20, milk:41, oil:32 } },
  { cat:"カレー", id:"sukiyaki_curry", name:"いあいぎりすき焼きカレー", ingredients: { leek:27, soymeat:26, honey:26, egg:22 } },
  { cat:"カレー", id:"awake_stew", name:"めざめるパワーシチュー", ingredients: { soy:28, tomato:25, mushroom:23, coffee:16 } },
  { cat:"カレー", id:"pumpkaboo_stew", name:"なりきりバケッチャシチュー", ingredients: { pumpkin:10, soymeat:16, potato:18, mushroom:25 } },
  { cat:"カレー", id:"keema_curry", name:"れんごくコーンキーマカレー", ingredients: { herb:27, soymeat:24, corn:14, ginger:12 } },
  { cat:"サラダ", id:"guacamole_chips", name:"じならしワカモレチップス", ingredients: { avocado:28, corn:25, herb:30, soy:22 } },
  { cat:"デザート", id:"pancake", name:"ドキドキこわいかおパンケーキ", ingredients: { pumpkin:18, egg:24, honey:32, tomato:29 } }
];

const el = (id) => document.getElementById(id);
let state = { recipeRows: [] };

function renderIngGrid() {
  const grid = el("ingGrid");
  grid.innerHTML = INGREDIENTS.map(ing => `
    <div class="tile">
      <div class="tileName">${ing.name}</div>
      <img class="icon" src="images/${ing.file}">
      <label class="chkLabel"><input type="checkbox" class="exChk" data-iid="${ing.id}">除外</label>
      <div style="width:100%"><input type="number" class="repQty" data-iid="${ing.id}" placeholder="補完0"></div>
    </div>`).join("");
  grid.querySelectorAll("input").forEach(i => i.oninput = calc);
}

function addRecipeRow(initData = null) {
  const rowId = crypto.randomUUID();
  const rowData = { 
    rowId, 
    cat: initData?.cat || "カレー", 
    recipeId: initData?.recipeId || RECIPES.find(r => r.cat === "カレー").id, 
    meals: initData?.meals || 0 
  };
  state.recipeRows.push(rowData);

  const wrap = document.createElement("div");
  wrap.className = "recipeRow";
  wrap.dataset.rowId = rowId;
  wrap.innerHTML = `
    <button class="removeBtn">×</button>
    <div style="width:85px;"><label>カテゴリ</label><select class="catSel"><option>カレー</option><option>サラダ</option><option>デザート</option></select></div>
    <div style="flex:1;"><label>料理</label><select class="recipeSel"></select></div>
    <div style="width:60px;"><label>食数</label><select class="mealsSel"></select></div>
    <div class="preview"></div>`;

  const cSel = wrap.querySelector(".catSel"), rSel = wrap.querySelector(".recipeSel"), mSel = wrap.querySelector(".mealsSel");

  cSel.value = rowData.cat;
  
  const updateRecipes = () => {
    const filtered = RECIPES.filter(r => r.cat === cSel.value);
    rSel.innerHTML = filtered.map(r => `<option value="${r.id}">${r.name}</option>`).join("");
    if (initData && filtered.some(r => r.id === rowData.recipeId)) {
        rSel.value = rowData.recipeId;
    }
    rowData.recipeId = rSel.value;
    updatePreview();
  };

  const updatePreview = () => {
    rowData.cat = cSel.value; rowData.recipeId = rSel.value; rowData.meals = Number(mSel.value);
    const r = RECIPES.find(x => x.id === rSel.value);
    wrap.querySelector(".preview").innerHTML = r ? Object.entries(r.ingredients).map(([id, q]) => 
      `<span><img src="images/${INGREDIENTS.find(i=>i.id===id).file}" style="width:12px;margin-right:3px;">${q}</span>`).join("") : "";
    updateAllMealOptions();
    calc();
  };

  cSel.onchange = () => { initData = null; updateRecipes(); };
  rSel.onchange = updatePreview;
  mSel.onchange = updatePreview;
  wrap.querySelector(".removeBtn").onclick = () => {
    state.recipeRows = state.recipeRows.filter(r => r.rowId !== rowId);
    wrap.remove();
    updateAllMealOptions();
    calc();
  };

  el("recipeList").appendChild(wrap);
  updateRecipes();
}

function updateAllMealOptions() {
  const currentTotal = state.recipeRows.reduce((s, r) => s + r.meals, 0);
  state.recipeRows.forEach(row => {
    const sel = document.querySelector(`[data-row-id="${row.rowId}"] .mealsSel`);
    if(!sel) return;
    const maxVal = MAX_TOTAL_MEALS - (currentTotal - row.meals);
    const prev = sel.value;
    sel.innerHTML = Array.from({length: maxVal + 1}, (_, i) => `<option value="${i}">${i}</option>`).join("");
    sel.value = Math.min(prev, maxVal);
    row.meals = Number(sel.value);
  });
}

function calc() {
  const exclude = new Set([...document.querySelectorAll(".exChk:checked")].map(c => c.dataset.iid));
  const reps = new Map([...document.querySelectorAll(".repQty")].map(i => [i.dataset.iid, Number(i.value) || 0]));
  
  const totalMeals = state.recipeRows.reduce((s, r) => s + r.meals, 0);
  const totalDays = totalMeals / MEALS_PER_DAY;
  el("summaryBadge").textContent = `合計 ${totalMeals}食（${totalDays.toFixed(1)}日分）`;

  const needs = new Map();
  state.recipeRows.forEach(row => {
    const r = RECIPES.find(x => x.id === row.recipeId);
    if (!r || row.meals <= 0) return;
    Object.entries(r.ingredients).forEach(([id, q]) => {
      // (1食あたりの個数 * 食数) - (1日あたりの補完量 * その料理の換算日数)
      const net = (q * row.meals) - (reps.get(id) || 0) * (row.meals / MEALS_PER_DAY);
      needs.set(id, (needs.get(id) || 0) + net);
    });
  });

  let grandTotal = 0;
  el("resultGrid").innerHTML = Array.from(needs.entries()).map(([id, val]) => {
    const final = Math.max(0, Math.ceil(val));
    if (final <= 0 || exclude.has(id)) return "";
    grandTotal += final;
    const ing = INGREDIENTS.find(i => i.id === id);
    return `<div class="tile"><div class="tileName">${ing.name}</div><img class="icon" src="images/${ing.file}"><div style="font-weight:900;">${final}個</div></div>`;
  }).join("");
  
  el("totalBadge").textContent = `総合計 ${grandTotal}個`;
  el("addRecipe").disabled = state.recipeRows.length >= 9;
}

el("addRecipe").onclick = () => addRecipeRow();
el("clearAll").onclick = () => { el("recipeList").innerHTML = ""; state.recipeRows = []; calc(); };

renderIngGrid();
addRecipeRow({ cat: "カレー", recipeId: "avocado_gratin", meals: 0 });
</script>
</body>
</html>
