<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>é£Ÿæã‚¹ãƒˆãƒƒã‚¯è¨ˆç®—</title>
  
  <link rel="apple-touch-icon" sizes="180x180" href="images/ã‚¢ã‚¤ã‚³ãƒ³.png">
  <link rel="icon" type="image/png" sizes="32x32" href="images/ã‚¢ã‚¤ã‚³ãƒ³.png">
  <link rel="icon" type="image/png" sizes="16x16" href="images/ã‚¢ã‚¤ã‚³ãƒ³.png">
  <link rel="manifest" href="manifest.webmanifest">
  
  <meta name="theme-color" content="#007bff">
  <meta name="background-color" content="#f5f8fa">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="é£Ÿæã‚¹ãƒˆãƒƒã‚¯">

<style>
    :root {
      --bg: #f5f8fa; 
      --card: #ffffff; 
      --main: #007bff; 
      --main-soft: #eaf4ff; 
      --text: #2c3e50; 
      --muted: #5d6d7e; 
      --line: #d6e0ea; 
      --danger: #e74c3c;
    }
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; 
      background: var(--bg); 
      color: var(--text); 
      line-height: 1.5; 
      -webkit-font-smoothing: antialiased;
    }
    
    header { 
      padding: 10px 20px; 
      background: var(--main);
      color: #fff; 
      position: sticky; 
      top: 0; 
      z-index: 10; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .title-text { font-weight: 800; letter-spacing: 0.03em; font-size: 18px; }
    .ver-text { font-size: 11px; font-weight: 400; opacity: 0.8; margin-top: 2px; }

    main { max-width: 980px; margin: 0 auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; }
    
    .card { 
      background: var(--card); 
      border: 1px solid var(--line); 
      border-radius: 16px; 
      padding: 16px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.02); 
    }
    
    .result-card { 
      border: 2px solid var(--main); 
      background: #ffffff; 
      border-radius: 16px; 
      padding: 16px; 
      box-shadow: 0 4px 20px rgba(0,123,255,0.1); 
    }

    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    
    .grid5 { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); 
      gap: 8px; 
      width: 100%;
    }
    
    label { font-size: 11px; font-weight: 700; color: var(--muted); display: block; margin-bottom: 4px; }
    
    select, input[type="number"] { 
      padding: 10px; 
      border: 1px solid var(--line); 
      border-radius: 10px; 
      font-size: 14px; 
      width: 100%; 
      background: #fff; 
      color: var(--text);
      transition: border-color 0.2s;
    }
    select:focus, input:focus { outline: none; border-color: var(--main); }

    button { 
      padding: 10px 16px; 
      border: 1px solid var(--line); 
      border-radius: 10px; 
      background: #fff; 
      font-weight: 800; 
      cursor: pointer; 
      font-size: 14px; 
      color: var(--text);
      transition: all 0.2s;
    }
    button.primary { background: var(--main); color: #fff; border-color: var(--main); }
    button.primary:active { transform: scale(0.98); }
    button.danger { color: var(--danger); border-color: #fadbd8; background: #fff; }
    
    .badge { font-size: 12px; padding: 4px 12px; border-radius: 999px; border: 1px solid var(--line); color: var(--text); background: #f8fafc; font-weight: 700; }
    
    #summaryBadge {
      background: var(--main-soft);
      color: var(--main);
      border: 1px solid #cce5ff;
    }

    .total-badge { background: var(--main); color: #fff; border: none; padding: 4px 16px; }
    .divider { height: 1px; background: var(--line); margin: 16px 0; }

    .tile { 
      border: 1px solid var(--line); 
      border-radius: 12px; 
      padding: 6px 3px; 
      display: flex; 
      flex-direction: column; 
      gap: 4px; 
      background: #fff; 
      align-items: center; 
      text-align: center; 
      min-height: 95px; 
      justify-content: space-between;
      min-width: 0;
    }
    .icon { width: 30px; height: 30px; object-fit: contain; }
    
    .tileName { 
      font-size: 8px; /* 8.5pxã‹ã‚‰8pxã«å¾®èª¿æ•´ */
      font-weight: 700; 
      width: 100%; 
      /* ä»¥ä¸‹ã€é•·ã„åå‰ãŒæ ã‚’çªãæŠœã‘ãªã„ãŸã‚ã®ä¿é™º */
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: clip; 
      letter-spacing: -0.05em; /* å­—é–“ã‚’å°‘ã—è©°ã‚ã€æ¨ªå¹…ã®ä½™è£•ã‚’ç¢ºä¿ */
      padding: 0 2px;
      display: block;
    }
    
    .chkLabel { display: flex; align-items: center; justify-content: center; gap: 4px; font-size: 10px; cursor: pointer; width: 100%; font-weight: 600; }
    .repInputRow { display: flex; align-items: center; justify-content: center; gap: 2px; width: 100%; }
    
    .repQty { 
      padding: 4px 1px; 
      font-size: 12px; 
      text-align: center; 
      border-radius: 8px; 
      border: 1px solid var(--line); 
      font-weight: 800; 
      width: 100%; 
      max-width: 48px; 
      min-width: 32px;
      appearance: textfield;
      -moz-appearance: textfield;
    }
  
    .repQty::-webkit-outer-spin-button,
    .repQty::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
  
    .recipeRow { 
      border: 1px solid var(--line); 
      background: #fcfdfe;
      border-radius: 16px; 
      padding: 16px; 
      display: flex; 
      gap: 12px; 
      flex-wrap: wrap; 
      align-items: flex-end; 
      margin-bottom: 12px; 
      position: relative;
    }
    
    .removeBtn { 
      position: absolute; top: -8px; right: -8px; 
      border: 1px solid var(--line); background: #fff; color: var(--danger); 
      font-size: 16px; 
      width: 26px; height: 26px;
      padding: 0;
      border-radius: 50%; 
      display: flex; align-items: center; justify-content: center; 
      font-weight: bold; z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      line-height: 0;
    }
    
    .recipeCol-cat { width: 95px; }
    .recipeCol-main { flex: 1; min-width: 140px; }
    .recipeCol-meals { width: 70px; }

    .preview { font-size: 12px; display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; border-top: 1px solid var(--line); padding-top: 10px; width: 100%; }
    .preview span { display: flex; align-items: center; background: var(--main-soft); color: var(--main); padding: 3px 8px; border-radius: 8px; font-weight: 700; border: 1px solid #d0e7ff; }

    @media (max-width: 480px) { 
      /* ã‚¹ãƒãƒ›ç­‰ã€ã‚ˆã‚Šç‹­ã„ç”»é¢ã§ã®è¨­å®š */
      .tileName { 
        font-size: 7px; /* 7.2pxã‹ã‚‰7pxã«ä¸‹ã’ã¦ã€9æ–‡å­—ã‚’ç¢ºå®Ÿã«åã‚ã‚‹ */
        letter-spacing: -0.06em; 
      }
    }
  </style>
</head>
<body>

<header>
  <div>
    <div class="title-text">é£Ÿæã‚¹ãƒˆãƒƒã‚¯è¨ˆç®—</div>
    <div class="ver-text">ver 1.0.1</div>
  </div>
  <a href="javascript:void(0)" id="openNotice" style="color:#fff; font-size:12px; font-weight:700; text-decoration:underline;">ã”åˆ©ç”¨ä¸Šã®æ³¨æ„</a>
</header>

<div id="noticeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; align-items:center; justify-content:center; padding:20px;">
  <div class="card" style="max-width:400px; width:100%; position:relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
    <div style="font-weight:900; margin-bottom:12px; border-bottom:1px solid var(--line); padding-bottom:8px; color:var(--text);">ã”åˆ©ç”¨ä¸Šã®æ³¨æ„</div>
    <p style="font-size:13px; color:var(--text); line-height:1.6; margin-bottom:20px;">
      ã“ã®ã‚¢ãƒ—ãƒªã¯éå…¬å¼ã§ã‚ã‚Šã€<strong>ï¾ˆï¾ƒï¾™.exeï¼ˆ@suiminloop.bsky.socialï¼‰</strong>ãŒå€‹äººã§ä½œã£ãŸã‚‚ã®ã§ã™ã€‚<br><br>
      ã”åˆ©ç”¨ã„ãŸã ãéš›ã¯è‡ªå·±è²¬ä»»ã§ãŠé¡˜ã„ã—ã¾ã™ğŸ™‡
    </p>
    <button id="closeNotice" class="primary" style="width:100%;">é–‰ã˜ã‚‹</button>
  </div>
</div>

<main>
  <section class="card">
    <div class="row" style="justify-content: space-between; align-items: flex-start;">
      <div>
        <div style="font-weight:900; font-size:15px; color:var(--text); margin-bottom: 4px;">æ¡ä»¶è¨­å®š</div>
        <span class="badge" id="summaryBadge">åˆè¨ˆ 0é£Ÿ / 21é£Ÿ</span>
      </div>
      <div class="row">
        <button id="addRecipe" class="primary">+ è¿½åŠ </button>
        <button id="clearAll" class="danger">ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
    <div id="recipeList" style="margin-top:10px;"></div>
  </section>

  <section class="card">
    <div style="font-weight:900; font-size:14px; margin-bottom:12px; border-left: 5px solid var(--main); padding-left: 10px; color: var(--text);">è¨ˆç®—ã‹ã‚‰é™¤å¤–</div>
    <div id="excludeGrid" class="grid5"></div>
  </section>

  <section class="card">
    <div style="font-weight:900; font-size:14px; margin-bottom:12px; border-left: 5px solid var(--main); padding-left: 10px; color: var(--text);">1æ—¥å½“ãŸã‚Šã®ç²å¾—é‡</div>
    <div id="replenishGrid" class="grid5"></div>
  </section>

  <section class="result-card">
    <div class="row" style="justify-content: space-between;">
      <div style="font-weight:900; font-size:16px; color:var(--main);">è¨ˆç®—çµæœ</div>
      <span class="badge total-badge" id="totalBadge">ç·åˆè¨ˆ 0å€‹</span>
    </div>
    <div class="divider" style="background: var(--main); opacity: 0.1;"></div>
    <div id="resultGrid" class="grid5"></div>
  </section>
</main>

<script>
const MEALS_PER_DAY = 3;
const MAX_RECIPE_ROWS = 9;
const MAX_TOTAL_MEALS = 21;

const INGREDIENTS = [
  { id:"leek", name:"ãµã¨ã„ãªãŒã­ã", file:"ãµã¨ã„ãªãŒã­ã.webp" },
  { id:"mushroom", name:"ã‚ã˜ã‚ã„ã‚­ãƒã‚³", file:"ã‚ã˜ã‚ã„ã‚­ãƒã‚³.webp" },
  { id:"egg", name:"ã¨ãã›ã‚“ã‚¨ãƒƒã‚°", file:"ã¨ãã›ã‚“ã‚¨ãƒƒã‚°.webp" },
  { id:"potato", name:"ã»ã£ã“ã‚Šãƒãƒ†ãƒˆ", file:"ã»ã£ã“ã‚Šãƒãƒ†ãƒˆ.webp" },
  { id:"apple", name:"ã¨ãã›ã‚“ãƒªãƒ³ã‚´", file:"ã¨ãã›ã‚“ãƒªãƒ³ã‚´.webp" },
  { id:"herb", name:"ã’ãã‹ã‚‰ãƒãƒ¼ãƒ–", file:"ã’ãã‹ã‚‰ãƒãƒ¼ãƒ–.webp" },
  { id:"soymeat", name:"ãƒãƒ¡ãƒŸãƒ¼ãƒˆ", file:"ãƒãƒ¡ãƒŸãƒ¼ãƒˆ.webp" },
  { id:"milk", name:"ãƒ¢ãƒ¼ãƒ¢ãƒ¼ãƒŸãƒ«ã‚¯", file:"ãƒ¢ãƒ¼ãƒ¢ãƒ¼ãƒŸãƒ«ã‚¯.webp" },
  { id:"honey", name:"ã‚ã¾ã„ãƒŸãƒ„", file:"ã‚ã¾ã„ãƒŸãƒ„.webp" },
  { id:"oil", name:"ãƒ”ãƒ¥ã‚¢ãªã‚ªã‚¤ãƒ«", file:"ãƒ”ãƒ¥ã‚¢ãªã‚ªã‚¤ãƒ«.webp" },
  { id:"ginger", name:"ã‚ã£ãŸã‹ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼", file:"ã‚ã£ãŸã‹ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼.webp" },
  { id:"tomato", name:"ã‚ã‚“ã¿ã‚“ãƒˆãƒãƒˆ", file:"ã‚ã‚“ã¿ã‚“ãƒˆãƒãƒˆ.webp" },
  { id:"cacao", name:"ãƒªãƒ©ãƒƒã‚¯ã‚¹ã‚«ã‚«ã‚ª", file:"ãƒªãƒ©ãƒƒã‚¯ã‚¹ã‚«ã‚«ã‚ª.webp" },
  { id:"tail", name:"ãŠã„ã—ã„ã‚·ãƒƒãƒ", file:"ãŠã„ã—ã„ã‚·ãƒƒãƒ.webp" },
  { id:"soy", name:"ãƒ¯ã‚«ã‚¯ã‚µå¤§è±†", file:"ãƒ¯ã‚«ã‚¯ã‚µå¤§è±†.webp" },
  { id:"corn", name:"ãƒ¯ã‚«ã‚¯ã‚µã‚³ãƒ¼ãƒ³", file:"ãƒ¯ã‚«ã‚¯ã‚µã‚³ãƒ¼ãƒ³.webp" },
  { id:"coffee", name:"ã‚ã–ã¾ã—ã‚³ãƒ¼ãƒ’ãƒ¼", file:"ã‚ã–ã¾ã—ã‚³ãƒ¼ãƒ’ãƒ¼.webp" },
  { id:"pumpkin", name:"ãšã£ã—ã‚Šã‚«ãƒœãƒãƒ£", file:"ãšã£ã—ã‚Šã‚«ãƒœãƒãƒ£.webp" },
  { id:"avocado", name:"ã¤ã‚„ã¤ã‚„ã‚¢ãƒœã‚«ãƒ‰", file:"ã¤ã‚„ã¤ã‚„ã‚¢ãƒœã‚«ãƒ‰.webp" }
];

const RECIPES = [
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"avocado_gratin", name:"ã—ã‚“ã‚Šã‚‡ãã‚¢ãƒœã‚«ãƒ‰ã‚°ãƒ©ã‚¿ãƒ³", ingredients: { avocado:22, potato:20, milk:41, oil:32 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"sukiyaki_curry", name:"ã„ã‚ã„ãã‚Šã™ãç„¼ãã‚«ãƒ¬ãƒ¼", ingredients: { leek:27, soymeat:26, honey:26, egg:22 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"awake_stew", name:"ã‚ã–ã‚ã‚‹ãƒ‘ãƒ¯ãƒ¼ã‚·ãƒãƒ¥ãƒ¼", ingredients: { soy:28, tomato:25, mushroom:23, coffee:16 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"pumpkaboo_stew", name:"ãªã‚Šãã‚Šãƒã‚±ãƒƒãƒãƒ£ã‚·ãƒãƒ¥ãƒ¼", ingredients: { pumpkin:10, soymeat:16, potato:18, mushroom:25 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"keema_curry", name:"ã‚Œã‚“ã”ãã‚³ãƒ¼ãƒ³ã‚­ãƒ¼ãƒã‚«ãƒ¬ãƒ¼", ingredients: { herb:27, soymeat:24, corn:14, ginger:12 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"ninja_curry", name:"ãƒ‹ãƒ³ã‚¸ãƒ£ã‚«ãƒ¬ãƒ¼", ingredients: { soy:24, soymeat:9, leek:12, mushroom:5 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"butter_curry", name:"ãœã£ãŸã„ã­ã‚€ã‚Šãƒã‚¿ãƒ¼ã‚«ãƒ¬ãƒ¼", ingredients: { potato:18, tomato:15, cacao:12, milk:10 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"tail_curry", name:"ã‚ã¶ã‚Šãƒ†ãƒ¼ãƒ«ã‚«ãƒ¬ãƒ¼", ingredients: { tail:8, herb:25 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"leek_curry", name:"ã‹ã‚‰ãã¡ãƒã‚®ã‚‚ã‚Šã‚«ãƒ¬ãƒ¼", ingredients: { leek:14, ginger:10, herb:8 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"punch_curry", name:"ãƒ”ãƒ¨ãƒ”ãƒ¨ãƒ‘ãƒ³ãƒè¾›å£ã‚«ãƒ¬ãƒ¼", ingredients: { coffee:11, herb:11, honey:11 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"corn_stew", name:"ã˜ã‚…ã†ãªã‚“ã‚³ãƒ¼ãƒ³ã‚·ãƒãƒ¥ãƒ¼", ingredients: { corn:14, milk:8, potato:8 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"parent_child_curry", name:"ãŠã‚„ã“ã‚ã„ã‚«ãƒ¬ãƒ¼", ingredients: { honey:12, apple:11, egg:8, potato:4 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"mushroom_curry", name:"ã‚­ãƒã‚³ã®ã»ã†ã—ã‚«ãƒ¬ãƒ¼", ingredients: { mushroom:14, potato:9 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"bulk_up_curry", name:"ãƒ“ãƒ«ãƒ‰ã‚¢ãƒƒãƒ—ãƒãƒ¡ã‚«ãƒ¬ãƒ¼", ingredients: { soy:12, soymeat:6, herb:4, egg:4 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"white_stew", name:"ã»ã£ã“ã‚Šãƒ›ãƒ¯ã‚¤ãƒˆã‚·ãƒãƒ¥ãƒ¼", ingredients: { milk:10, potato:8, mushroom:4 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"omurice_curry", name:"ã¨ã‘ã‚‹ã‚ªãƒ ã‚«ãƒ¬ãƒ¼", ingredients: { egg:10, tomato:6 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"tomato_curry", name:"ã‚µãƒ³ãƒ‘ãƒ¯ãƒ¼ãƒˆãƒãƒˆã‚«ãƒ¬ãƒ¼", ingredients: { tomato:10, herb:5 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"cutlet_curry", name:"ã²ã§ã‚Šã‚«ãƒ„ãƒ¬ãƒ„ã‚«ãƒ¬ãƒ¼", ingredients: { soymeat:10, oil:5 } },
  { cat:"ã‚«ãƒ¬ãƒ¼", id:"cheese_hamburg_curry", name:"æº€è…¹ãƒãƒ¼ã‚ºãƒãƒ¼ã‚°ã‚«ãƒ¬ãƒ¼", ingredients: { milk:8, soymeat:8 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"guacamole_chips", name:"ã˜ãªã‚‰ã—ãƒ¯ã‚«ãƒ¢ãƒ¬ãƒãƒƒãƒ—ã‚¹", ingredients: { avocado:28, corn:25, herb:30, soy:22 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"coffee_salad", name:"ã¾ã‘ã‚“ãã‚³ãƒ¼ãƒ’ãƒ¼ã‚µãƒ©ãƒ€", ingredients: { coffee:28, soymeat:28, oil:22, potato:22 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"apple_yogurt_salad", name:"ã‚Šã‚“ã”ã•ã‚“ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆã‚µãƒ©ãƒ€", ingredients: { egg:35, apple:28, tomato:23, milk:18 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"mimosa_salad", name:"ã¯ãªãµã¶ããƒŸãƒ¢ã‚¶ã‚µãƒ©ãƒ€", ingredients: { egg:25, oil:17, potato:15, soymeat:12 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"ninja_salad", name:"ãƒ‹ãƒ³ã‚¸ãƒ£ã‚µãƒ©ãƒ€", ingredients: { leek:15, soy:19, mushroom:12, ginger:11 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"wakakusa_salad", name:"ãƒ¯ã‚«ã‚¯ã‚µã‚µãƒ©ãƒ€", ingredients: { oil:22, corn:17, tomato:14, potato:9 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"cross_chop_salad", name:"ã‚¯ãƒ­ã‚¹ãƒãƒ§ãƒƒãƒ—ãƒ‰ã‚µãƒ©ãƒ€", ingredients: { egg:20, soymeat:15, corn:11, tomato:10 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"tail_pepper_salad", name:"ãƒ¤ãƒ‰ãƒ³ãƒ†ãƒ¼ãƒ«ã®ãƒšãƒƒãƒ‘ãƒ¼ã‚µãƒ©ãƒ€", ingredients: { tail:10, herb:10, oil:15 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"sweet_salad", name:"ã‚ã„ãã†ã‚¹ã‚¤ãƒ¼ãƒˆã‚µãƒ©ãƒ€", ingredients: { apple:21, honey:16, corn:12 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"avocado_salad", name:"ãã ã‘ã‚‹ã‚¢ãƒœã‚«ãƒ‰ã‚µãƒ©ãƒ€", ingredients: { avocado:14, soy:18, oil:10 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"mushroom_spore_salad", name:"ã‚­ãƒã‚³ã®ã»ã†ã—ã‚µãƒ©ãƒ€", ingredients: { mushroom:17, tomato:8, oil:8 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"overheat_salad", name:"ã‚ªãƒ¼ãƒãƒ¼ãƒ’ãƒ¼ãƒˆã‚µãƒ©ãƒ€", ingredients: { herb:17, ginger:10, tomato:8 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"gluttony_potato_salad", name:"ãã„ã—ã‚“ã¼ã†ãƒãƒ†ãƒˆã‚µãƒ©ãƒ€", ingredients: { potato:14, egg:9, soymeat:7, apple:6 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"choco_mint_salad", name:"ãƒ ãƒ©ã£ã‘ãƒãƒ§ã‚³ãƒŸãƒ³ãƒˆã‚µãƒ©ãƒ€", ingredients: { cacao:14, soymeat:9 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"tofu_salad", name:"ã†ã‚‹ãŠã„ã¨ã†ãµã‚µãƒ©ãƒ€", ingredients: { soy:15, tomato:9 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"wild_salad", name:"ã°ã‹ã¢ã‹ã‚‰ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚µãƒ©ãƒ€", ingredients: { soymeat:9, ginger:6, egg:5, potato:3 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"caprese", name:"ãƒ¢ãƒ¼ãƒ¢ãƒ¼ã‚«ãƒ—ãƒ¬ãƒ¼ã‚¼", ingredients: { milk:12, tomato:6, oil:5 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"immunity_leek_salad", name:"ã‚ã‚“ãˆãã­ãã‚µãƒ©ãƒ€", ingredients: { leek:10, ginger:5 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"corn_salad", name:"ã¿ã ã‚Œã¥ãã‚³ãƒ¼ãƒ³ã‚µãƒ©ãƒ€", ingredients: { corn:9, oil:8 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"apple_cheese_salad", name:"ãƒ¡ãƒ­ãƒ¡ãƒ­ã‚Šã‚“ã”ã®ãƒãƒ¼ã‚ºã‚µãƒ©ãƒ€", ingredients: { apple:15, milk:5, oil:3 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"hot_air_tofu_salad", name:"ã­ã£ã·ã†ã¨ã†ãµã‚µãƒ©ãƒ€", ingredients: { soy:10, herb:6 } },
  { cat:"ã‚µãƒ©ãƒ€", id:"caesar_salad", name:"ã‚†ãã‹ãã‚·ãƒ¼ã‚¶ãƒ¼ã‚µãƒ©ãƒ€", ingredients: { milk:10, soymeat:6 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"pancake", name:"ãƒ‰ã‚­ãƒ‰ã‚­ã“ã‚ã„ã‹ãŠãƒ‘ãƒ³ã‚±ãƒ¼ã‚­", ingredients: { pumpkin:18, egg:24, honey:32, tomato:29 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"eclair", name:"ãƒ‰ã‚ªãƒ¼ã®ã‚¨ã‚¯ãƒ¬ã‚¢", ingredients: { cacao:30, milk:26, coffee:24, honey:22 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"cola", name:"ã‚¹ãƒ‘ã‚¤ã‚¯ã‚¹ãƒ‘ã‚¤ã‚¹ã‚³ãƒ¼ãƒ©", ingredients: { apple:35, ginger:20, leek:20, coffee:12 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"macaron", name:"ãƒ•ãƒ©ãƒ¯ãƒ¼ã‚®ãƒ•ãƒˆãƒã‚«ãƒ­ãƒ³", ingredients: { cacao:25, egg:25, honey:17, milk:10 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"scone", name:"ãŠã¡ã‚ƒã‹ã„ã‚³ãƒ¼ãƒ³ã‚¹ã‚³ãƒ¼ãƒ³", ingredients: { apple:20, ginger:20, corn:18, milk:9 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"smoothie", name:"ã‚°ãƒ©ã‚¹ãƒŸã‚­ã‚µãƒ¼ã‚¹ãƒ ãƒ¼ã‚¸ãƒ¼", ingredients: { avocado:18, tomato:16, milk:14 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"pudding_ala_mode", name:"ãƒ—ãƒªãƒ³ã®ãƒ—ãƒªãƒ³ã‚¢ãƒ©ãƒ¢ãƒ¼ãƒ‰", ingredients: { honey:20, egg:15, milk:10, apple:10 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"tiramisu", name:"ã‹ãŸã‚„ã¶ã‚Šã‚³ãƒ¼ãƒ³ãƒ†ã‚£ãƒ©ãƒŸã‚¹", ingredients: { coffee:14, corn:14, milk:12 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"coffee_jelly", name:"ã¯ã‚„ãŠãã‚³ãƒ¼ãƒ’ãƒ¼ã‚¼ãƒªãƒ¼", ingredients: { coffee:16, milk:14, honey:12 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"popcorn", name:"ã ã„ã°ãã¯ã¤ãƒãƒƒãƒ—ã‚³ãƒ¼ãƒ³", ingredients: { corn:15, oil:14, milk:7 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"donut", name:"ã¡ã‹ã‚‰ã‚‚ã¡ã‚½ã‚¤ãƒ‰ãƒ¼ãƒŠãƒƒãƒ„", ingredients: { oil:12, soy:16, cacao:7 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"tea", name:"ãƒãƒ­ãƒªã®ãƒ‡ãƒˆãƒƒã‚¯ã‚¹ãƒ†ã‚£ãƒ¼", ingredients: { ginger:11, apple:15, mushroom:9 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"cookie", name:"ãµãã¤ã®ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼ã‚¯ãƒƒã‚­ãƒ¼", ingredients: { honey:14, ginger:12, cacao:5, egg:4 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"fruit_ore", name:"ã‚ãã¾ã®ã‚­ãƒƒã‚¹ãƒ•ãƒ«ãƒ¼ãƒ„ã‚ªãƒ¬", ingredients: { apple:11, milk:9, honey:7, cacao:8 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"choco_cake", name:"ã‚ã¾ã„ã‹ãŠã‚Šãƒãƒ§ã‚³ã‚±ãƒ¼ã‚­", ingredients: { honey:9, cacao:8, milk:7 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"choco_tart", name:"ã¯ãªã³ã‚‰ã®ã¾ã„ãƒãƒ§ã‚³ã‚¿ãƒ«ãƒˆ", ingredients: { cacao:11, apple:11 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"protein_smoothie", name:"ã¯ã‚Šãã‚Šãƒ—ãƒ­ãƒ†ã‚¤ãƒ³ã‚¹ãƒ ãƒ¼ã‚¸ãƒ¼", ingredients: { soy:15, cacao:8 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"malasada", name:"ãŠãŠãã„ãƒãƒ©ã‚µãƒ€", ingredients: { oil:10, milk:7, honey:6 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"soy_cake", name:"ã‹ã‚‹ã‚ã–ã‚½ã‚¤ã‚±ãƒ¼ã‚­", ingredients: { egg:8, soy:7 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"veg_juice", name:"ãƒã‚¤ãƒšãƒ¼ã‚¹ã‚„ã•ã„ã‚¸ãƒ¥ãƒ¼ã‚¹", ingredients: { tomato:9, apple:7 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"ginger_tea", name:"ã²ã®ã“ã®ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼ãƒ†ã‚£ãƒ¼", ingredients: { ginger:9, apple:7 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"sweet_potato", name:"ã˜ã‚…ãã›ã„ã‚¹ã‚¤ãƒ¼ãƒˆãƒãƒ†ãƒˆ", ingredients: { potato:9, milk:5 } },
  { cat:"ãƒ‡ã‚¶ãƒ¼ãƒˆ", id:"apple_pie", name:"ã­ãŒã„ã”ã¨ã‚¢ãƒƒãƒ—ãƒ«ãƒ‘ã‚¤", ingredients: { apple:12, milk:4 } }
];


const el = (id) => document.getElementById(id);
let state = { recipeRows: [] };

function getIng(id) { return INGREDIENTS.find(x => x.id === id); }
function imgSrc(file) { return "images/" + encodeURIComponent(file); }

function renderGrids() {
  const ex = el("excludeGrid"), rep = el("replenishGrid");
  ex.innerHTML = ""; rep.innerHTML = "";
  INGREDIENTS.forEach(ing => {
    ex.innerHTML += `
      <div class="tile">
        <div class="tileName" title="${ing.name}">${ing.name}</div>
        <img class="icon" src="${imgSrc(ing.file)}" alt="">
        <label class="chkLabel"><input type="checkbox" class="exChk" data-iid="${ing.id}">é™¤å¤–</label>
      </div>`;
    rep.innerHTML += `
      <div class="tile">
        <div class="tileName" title="${ing.name}">${ing.name}</div>
        <img class="icon" src="${imgSrc(ing.file)}" alt="">
        <div class="repInputRow">
          <input type="number" class="repQty" data-iid="${ing.id}" placeholder="0">
          <span class="suffix" style="font-size:10px;">å€‹</span>
        </div>
      </div>`;
  });

  document.querySelectorAll(".exChk, .repQty").forEach(input => {
    input.oninput = (e) => {
      if (e.target.classList.contains("repQty")) {
        if (e.target.value > 999) e.target.value = 999;
        if (e.target.value < 0) e.target.value = 0;
      }
      calc();
    };
  });
}

function addRecipeRow(init) {
  if (state.recipeRows.length >= MAX_RECIPE_ROWS) return;

  const rowId = crypto.randomUUID();
  const rowData = { rowId, cat: init?.cat || "ã‚«ãƒ¬ãƒ¼", recipeId: init?.recipeId || RECIPES[0].id, meals: init?.meals || 0 };
  state.recipeRows.push(rowData);

  const wrap = document.createElement("div");
  wrap.className = "recipeRow";
  wrap.dataset.rowId = rowId;
  wrap.innerHTML = `
    <button class="removeBtn" title="å‰Šé™¤">Ã—</button>
    <div class="recipeCol-cat"><label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label><select class="catSel"><option>ã‚«ãƒ¬ãƒ¼</option><option>ã‚µãƒ©ãƒ€</option><option>ãƒ‡ã‚¶ãƒ¼ãƒˆ</option></select></div>
    <div class="recipeCol-main"><label>æ–™ç†</label><select class="recipeSel"></select></div>
    <div class="recipeCol-meals"><label>é£Ÿæ•°</label><select class="mealsSel"></select></div>
    <div class="preview"></div>`;

  const cSel = wrap.querySelector(".catSel"), rSel = wrap.querySelector(".recipeSel"), mSel = wrap.querySelector(".mealsSel"), pre = wrap.querySelector(".preview");
  
  const updateRecipeList = () => {
    const filtered = RECIPES.filter(r => r.cat === cSel.value);
    rSel.innerHTML = filtered.map(r => `<option value="${r.id}">${r.name}</option>`).join("");
    if (filtered.some(r => r.id === rowData.recipeId)) {
        rSel.value = rowData.recipeId;
    } else {
        rowData.recipeId = rSel.value;
    }
    updatePreview();
  };

  const updatePreview = () => {
    rowData.cat = cSel.value; rowData.recipeId = rSel.value; rowData.meals = Number(mSel.value);
    const r = RECIPES.find(x => x.id === rSel.value);
    if (r) {
      pre.innerHTML = Object.entries(r.ingredients).map(([id, q]) => {
        const ing = getIng(id);
        return `<span><img src="${imgSrc(ing.file)}" style="width:14px; height:14px; margin-right:4px; vertical-align:middle;">${q}</span>`;
      }).join("");
    }
    updateAllMealDropdowns();
    calc();
  };

  cSel.onchange = updateRecipeList;
  rSel.onchange = updatePreview;
  mSel.onchange = updatePreview;
  wrap.querySelector(".removeBtn").onclick = () => {
    state.recipeRows = state.recipeRows.filter(r => r.rowId !== rowId);
    wrap.remove();
    updateAllMealDropdowns();
    checkAddButton();
    calc();
  };

  cSel.value = rowData.cat;
  updateRecipeList();
  
  el("recipeList").appendChild(wrap);
  updateAllMealDropdowns();
  checkAddButton();
}

function updateAllMealDropdowns() {
  const currentTotal = state.recipeRows.reduce((sum, r) => sum + r.meals, 0);
  state.recipeRows.forEach(row => {
    const wrap = document.querySelector(`.recipeRow[data-row-id="${row.rowId}"]`);
    if (!wrap) return;
    const mSel = wrap.querySelector(".mealsSel");
    const otherMeals = currentTotal - row.meals;
    const maxAvailable = MAX_TOTAL_MEALS - otherMeals;
    const prevVal = Number(mSel.value) || row.meals;
    mSel.innerHTML = "";
    for (let i = 0; i <= maxAvailable; i++) {
      const opt = document.createElement("option");
      opt.value = i; opt.textContent = i;
      mSel.appendChild(opt);
    }
    mSel.value = Math.min(prevVal, maxAvailable);
    row.meals = Number(mSel.value);
  });
}

function checkAddButton() { el("addRecipe").disabled = state.recipeRows.length >= MAX_RECIPE_ROWS; }

function calc() {
  const exclude = new Set([...document.querySelectorAll(".exChk:checked")].map(c => c.dataset.iid));
  const replenishMap = new Map([...document.querySelectorAll(".repQty")].map(c => [c.dataset.iid, Number(c.value) || 0]));

  const totalMeals = state.recipeRows.reduce((sum, r) => sum + r.meals, 0);
  el("summaryBadge").textContent = `åˆè¨ˆ ${totalMeals}é£Ÿ / 21é£Ÿ`;

  const netNeed = new Map();
  // è¡¨ç¤ºé †ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®é…åˆ—
  const displayOrder = [];

  state.recipeRows.forEach(row => {
    if (row.meals <= 0) return;
    const r = RECIPES.find(x => x.id === row.recipeId);
    if (!r) return;
    
    const rowDays = row.meals / MEALS_PER_DAY;
    
    // æ–™ç†ãƒ‡ãƒ¼ã‚¿(RECIPES)ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹é£Ÿæã®ä¸¦ã³é †ã§ãƒ«ãƒ¼ãƒ—
    Object.entries(r.ingredients).forEach(([iid, qtyPerMeal]) => {
      // ã¾ã  displayOrder ã«å…¥ã£ã¦ã„ãªã„é£Ÿæãªã‚‰è¿½åŠ ï¼ˆã“ã‚Œã§æ–™ç†ã”ã¨ã®ä¸¦ã³é †ã‚’ä¿æŒï¼‰
      if (!displayOrder.includes(iid)) {
        displayOrder.push(iid);
      }

      const gross = qtyPerMeal * row.meals;
      const rowReplenish = (replenishMap.get(iid) || 0) * rowDays;
      const currentNet = netNeed.get(iid) || 0;
      netNeed.set(iid, currentNet + (gross - rowReplenish));
    });
  });

  const resultGrid = el("resultGrid");
  resultGrid.innerHTML = "";
  let grandTotal = 0;

  // å…¨é£Ÿæãƒªã‚¹ãƒˆã§ã¯ãªãã€æ–™ç†ã‹ã‚‰æŠ½å‡ºã—ãŸä¸¦ã³é †(displayOrder)ã§å‡ºåŠ›
  displayOrder.forEach(iid => {
    if (exclude.has(iid)) return;
    const ing = getIng(iid);
    if (!ing) return;

    const finalNeed = Math.max(0, Math.ceil(netNeed.get(iid) || 0));
    if (finalNeed > 0) {
      grandTotal += finalNeed;
      resultGrid.innerHTML += `
        <div class="tile">
          <div class="tileName" title="${ing.name}">${ing.name}</div>
          <img class="icon" src="${imgSrc(ing.file)}" alt="">
          <div class="resultQty" style="font-weight:900; color:var(--text); font-size: 13px;">${finalNeed}<span class="suffix">å€‹</span></div>
        </div>`;
    }
  });
  el("totalBadge").textContent = `ç·åˆè¨ˆ ${grandTotal}å€‹`;
}

// æ³¨æ„äº‹é …ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆ¶å¾¡
const modal = el("noticeModal");
const openBtn = el("openNotice");
const closeBtn = el("closeNotice");

openBtn.onclick = () => { modal.style.display = "flex"; };
closeBtn.onclick = () => { modal.style.display = "none"; };
window.onclick = (event) => {
  if (event.target == modal) { modal.style.display = "none"; }
};

el("addRecipe").onclick = () => addRecipeRow({meals: 0});
el("clearAll").onclick = () => { 
  el("recipeList").innerHTML = ""; 
  state.recipeRows = []; 
  document.querySelectorAll(".exChk").forEach(chk => chk.checked = false);
  document.querySelectorAll(".repQty").forEach(input => input.value = "");
  checkAddButton();
  addRecipeRow({ cat: "ã‚«ãƒ¬ãƒ¼", recipeId: "avocado_gratin", meals: 0 });
  calc(); 
};

renderGrids();
addRecipeRow({ cat: "ã‚«ãƒ¬ãƒ¼", recipeId: "avocado_gratin", meals: 0 });

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js')
    .then(() => console.log('Service Worker Registered'));
}
</script>
</body>
</html>
