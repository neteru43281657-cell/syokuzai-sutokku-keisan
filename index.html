<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>食材ストック計算 ver1.0.0</title>
  <style>
    :root {
      --bg: #f6f7fb; --card: #fff; --text: #111; --muted: #666; --line: #e6e8f0; --danger: #b00020;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.4; }
    header { padding: 12px 14px; font-weight: 800; background: #111; color: #fff; position: sticky; top: 0; z-index: 5; }
    main { max-width: 980px; margin: 0 auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
    
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    
    .grid4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    
    label { font-size: 11px; color: var(--muted); display: block; margin-bottom: 2px; }
    select, input[type="number"] { padding: 6px; border: 1px solid var(--line); border-radius: 10px; font-size: 14px; width: 100%; background: #fff; }
    button { padding: 8px 12px; border: 1px solid var(--line); border-radius: 10px; background: #fff; font-weight: 800; cursor: pointer; font-size: 13px; }
    button.primary { background: #111; color: #fff; }
    button.danger { color: var(--danger); border-color: #f0c2c7; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .badge { font-size: 11px; padding: 3px 8px; border-radius: 999px; border: 1px solid var(--line); color: var(--muted); background: #fff; }
    .divider { height: 1px; background: var(--line); margin: 8px 0; }

    .tile { border: 1px solid var(--line); border-radius: 10px; padding: 6px; display: flex; flex-direction: column; gap: 4px; background: #fff; align-items: center; text-align: center; }
    .icon { width: 32px; height: 32px; object-fit: contain; }
    .tileName { font-size: 10px; font-weight: 800; height: 2.4em; display: flex; align-items: center; justify-content: center; line-height: 1.2; }
    
    .chkLabel { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 4px; 
      font-size: 11px; 
      color: var(--muted); 
      cursor: pointer;
      margin-top: 2px;
    }
    .chkLabel input[type="checkbox"] { margin: 0; cursor: pointer; }

    .repInputRow { display: flex; align-items: center; gap: 2px; width: 100%; margin-top: 2px; }
    .repQty { padding: 2px 4px; font-size: 12px; text-align: center; }
    .suffix { font-size: 10px; color: var(--muted); }

    .recipeRow { border: 1px dashed var(--line); border-radius: 12px; padding: 10px; display: flex; gap: 8px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 8px; position: relative; }
    .removeBtn { position: absolute; top: 5px; right: 5px; border: none; background: none; color: var(--danger); font-size: 16px; cursor: pointer; padding: 0 5px; }
    .preview { font-size: 11px; display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; border-top: 1px solid #f0f1f5; padding-top: 6px; }
    .preview span { display: flex; align-items: center; background: #f0f1f5; padding: 2px 6px; border-radius: 6px; }

    @media (max-width: 360px) { .grid4 { gap: 4px; } .tile { padding: 4px; } }
  </style>
</head>
<body>

<header>食材ストック計算 ver1.0.0</header>

<main>
  <section class="card">
    <div class="row" style="justify-content: space-between; align-items: flex-start;">
      <div>
        <div style="font-weight:900; font-size:14px;">条件</div>
        <div class="row" style="margin-top:4px;">
          <span class="badge" id="summaryBadge">合計 0食</span>
        </div>
      </div>
      <div class="row">
        <button id="addRecipe" class="primary">+ 追加</button>
        <button id="clearAll" class="danger">クリア</button>
      </div>
    </div>
    <div id="recipeList" style="margin-top:8px;"></div>
  </section>

  <section class="card">
    <div style="font-weight:900; font-size:13px; margin-bottom:8px;">計算から除外</div>
    <div id="excludeGrid" class="grid4"></div>
  </section>

  <section class="card">
    <div style="font-weight:900; font-size:13px; margin-bottom:8px;">1日当たりの補完量</div>
    <div id="replenishGrid" class="grid4"></div>
  </section>

  <section class="card">
    <div class="row" style="justify-content: space-between;">
      <div style="font-weight:900; font-size:14px;">計算結果</div>
      <span class="badge" id="totalBadge" style="color:#111; font-weight:800;">総合計 0個</span>
    </div>
    <div class="divider"></div>
    <div id="resultGrid" class="grid4"></div>
  </section>
</main>

<script>
const MEALS_PER_DAY = 3;
const MAX_RECIPE_ROWS = 9;
const MAX_TOTAL_MEALS = 21;

const INGREDIENTS = [
  { id:"leek", name:"ふといながねぎ", file:"ふといながねぎ.webp" },
  { id:"mushroom", name:"あじわいキノコ", file:"あじわいキノコ.webp" },
  { id:"egg", name:"とくせんエッグ", file:"とくせんエッグ.webp" },
  { id:"potato", name:"ほっこりポテト", file:"ほっこりポテト.webp" },
  { id:"apple", name:"とくせんリンゴ", file:"とくせんリンゴ.webp" },
  { id:"herb", name:"げきからハーブ", file:"げきからハーブ.webp" },
  { id:"soymeat", name:"マメミート", file:"マメミート.webp" },
  { id:"milk", name:"モーモーミルク", file:"モーモーミルク.webp" },
  { id:"honey", name:"あまいミツ", file:"あまいミツ.webp" },
  { id:"oil", name:"ピュアなオイル", file:"ピュアなオイル.webp" },
  { id:"ginger", name:"あったかジンジャー", file:"あったかジンジャー.webp" },
  { id:"tomato", name:"あんみんトマト", file:"あんみんトマト.webp" },
  { id:"cacao", name:"リラックスカカオ", file:"リラックスカカオ.webp" },
  { id:"tail", name:"おいしいシッポ", file:"おいしいシッポ.webp" },
  { id:"soy", name:"ワカクサ大豆", file:"ワカクサ大豆.webp" },
  { id:"corn", name:"ワカクサコーン", file:"ワカクサコーン.webp" },
  { id:"coffee", name:"めざましコーヒー", file:"めざましコーヒー.webp" },
  { id:"pumpkin", name:"ずっしりカボチャ", file:"ずっしりカボチャ.webp" },
  { id:"avocado", name:"つやつやアボカド", file:"つやつやアボカド.webp" }
];

const RECIPES = [
  // カレー
  { cat:"カレー", id:"avocado_gratin", name:"しんりょくアボカドグラタン", ingredients: { avocado:22, potato:20, milk:41, oil:32 } },
  { cat:"カレー", id:"sukiyaki_curry", name:"いあいぎりすき焼きカレー", ingredients: { leek:27, soymeat:26, honey:26, egg:22 } },
  { cat:"カレー", id:"awake_stew", name:"めざめるパワーシチュー", ingredients: { soy:28, tomato:25, mushroom:23, coffee:16 } },
  { cat:"カレー", id:"pumpkaboo_stew", name:"なりきりバケッチャシチュー", ingredients: { pumpkin:10, soymeat:16, potato:18, mushroom:25 } },
  { cat:"カレー", id:"keema_curry", name:"れんごくコーンキーマカレー", ingredients: { herb:27, soymeat:24, corn:14, ginger:12 } },
  { cat:"カレー", id:"ninja_curry", name:"ニンジャカレー", ingredients: { soy:24, soymeat:9, leek:12, mushroom:5 } },
  { cat:"カレー", id:"butter_curry", name:"ぜったいねむりバターカレー", ingredients: { potato:18, tomato:15, cacao:12, milk:10 } },
  { cat:"カレー", id:"tail_curry", name:"あぶりテールカレー", ingredients: { tail:8, herb:25 } },
  { cat:"カレー", id:"leek_curry", name:"からくちネギもりカレー", ingredients: { leek:14, ginger:10, herb:8 } },
  { cat:"カレー", id:"punch_curry", name:"ピヨピヨパンチ辛口カレー", ingredients: { coffee:11, herb:11, honey:11 } },
  { cat:"カレー", id:"corn_stew", name:"じゅうなんコーンシチュー", ingredients: { corn:14, milk:8, potato:8 } },
  { cat:"カレー", id:"parent_child_curry", name:"おやこあいカレー", ingredients: { honey:12, apple:11, egg:8, potato:4 } },
  { cat:"カレー", id:"mushroom_curry", name:"キノコのほうしカレー", ingredients: { mushroom:14, potato:9 } },
  { cat:"カレー", id:"bulk_up_curry", name:"ビルドアップマメカレー", ingredients: { soy:12, soymeat:6, herb:4, egg:4 } },
  { cat:"カレー", id:"white_stew", name:"ほっこりホワイトシチュー", ingredients: { milk:10, potato:8, mushroom:4 } },
  { cat:"カレー", id:"omurice_curry", name:"とけるオムカレー", ingredients: { egg:10, tomato:6 } },
  { cat:"カレー", id:"tomato_curry", name:"サンパワートマトカレー", ingredients: { tomato:10, herb:5 } },
  { cat:"カレー", id:"cutlet_curry", name:"ひでりカツレツカレー", ingredients: { soymeat:10, oil:5 } },
  { cat:"カレー", id:"cheese_hamburg_curry", name:"満腹チーズバーグカレー", ingredients: { milk:8, soymeat:8 } },

  // サラダ
  { cat:"サラダ", id:"guacamole_chips", name:"じならしワカモレチップス", ingredients: { avocado:28, corn:25, herb:30, soy:22 } },
  { cat:"サラダ", id:"coffee_salad", name:"まけんきコーヒーサラダ", ingredients: { coffee:28, soymeat:28, oil:22, potato:22 } },
  { cat:"サラダ", id:"apple_yogurt_salad", name:"りんごさんヨーグルトサラダ", ingredients: { egg:35, apple:28, tomato:23, milk:18 } },
  { cat:"サラダ", id:"mimosa_salad", name:"はなふぶきミモザサラダ", ingredients: { egg:25, oil:17, potato:15, soymeat:12 } },
  { cat:"サラダ", id:"ninja_salad", name:"ニンジャサラダ", ingredients: { leek:15, soy:19, mushroom:12, ginger:11 } },
  { cat:"サラダ", id:"wakakusa_salad", name:"ワカクササラダ", ingredients: { oil:22, corn:17, tomato:14, potato:9 } },
  { cat:"サラダ", id:"cross_chop_salad", name:"クロスチョップサラダ", ingredients: { egg:20, soymeat:15, corn:11, tomato:10 } },
  { cat:"サラダ", id:"tail_pepper_salad", name:"ヤドンテールのペッパーサラダ", ingredients: { tail:10, herb:10, oil:15 } },
  { cat:"サラダ", id:"sweet_salad", name:"めいそうスイートサラダ", ingredients: { apple:21, honey:16, corn:12 } },
  { cat:"サラダ", id:"avocado_salad", name:"くだけるアボカドサラダ", ingredients: { avocado:14, soy:18, oil:10 } },
  { cat:"サラダ", id:"mushroom_spore_salad", name:"キノコのほうしサラダ", ingredients: { mushroom:17, tomato:8, oil:8 } },
  { cat:"サラダ", id:"overheat_salad", name:"オーバーヒートサラダ", ingredients: { herb:17, ginger:10, tomato:8 } },
  { cat:"サラダ", id:"gluttony_potato_salad", name:"くいしんぼうポテトサラダ", ingredients: { potato:14, egg:9, soymeat:7, apple:6 } },
  { cat:"サラダ", id:"choco_mint_salad", name:"ムラっけチョコミントサラダ", ingredients: { cacao:14, soymeat:9 } },
  { cat:"サラダ", id:"tofu_salad", name:"うるおいとうふサラダ", ingredients: { soy:15, tomato:9 } },
  { cat:"サラダ", id:"wild_salad", name:"ばかぢからワイルドサラダ", ingredients: { soymeat:9, ginger:6, egg:5, potato:3 } },
  { cat:"サラダ", id:"caprese", name:"モーモーカプレーゼ", ingredients: { milk:12, tomato:6, oil:5 } },
  { cat:"サラダ", id:"immunity_leek_salad", name:"めんえきねぎサラダ", ingredients: { leek:10, ginger:5 } },
  { cat:"サラダ", id:"corn_salad", name:"みだれづきコーンサラダ", ingredients: { corn:9, oil:8 } },
  { cat:"サラダ", id:"apple_cheese_salad", name:"メロメロりんごのチーズサラダ", ingredients: { apple:15, milk:5, oil:3 } },
  { cat:"サラダ", id:"hot_air_tofu_salad", name:"ねっぷうとうふサラダ", ingredients: { soy:10, herb:6 } },
  { cat:"サラダ", id:"caesar_salad", name:"ゆきかきシーザーサラダ", ingredients: { milk:10, soymeat:6 } },

  // デザート
  { cat:"デザート", id:"pancake", name:"ドキドキこわいかおパンケーキ", ingredients: { pumpkin:18, egg:24, honey:32, tomato:29 } },
  { cat:"デザート", id:"eclair", name:"ドオーのエクレア", ingredients: { cacao:30, milk:26, coffee:24, honey:22 } },
  { cat:"デザート", id:"cola", name:"スパイクスパイスコーラ", ingredients: { apple:35, ginger:20, leek:20, coffee:12 } },
  { cat:"デザート", id:"macaron", name:"フラワーギフトマカロン", ingredients: { cacao:25, egg:25, honey:17, milk:10 } },
  { cat:"デザート", id:"scone", name:"おちゃかいコーンスコーン", ingredients: { apple:20, ginger:20, corn:18, milk:9 } },
  { cat:"デザート", id:"smoothie", name:"グラスミキサースムージー", ingredients: { avocado:18, tomato:16, milk:14 } },
  { cat:"デザート", id:"pudding_ala_mode", name:"プリンのプリンアラモード", ingredients: { honey:20, egg:15, milk:10, apple:10 } },
  { cat:"デザート", id:"tiramisu", name:"かたやぶりコーンティラミス", ingredients: { coffee:14, corn:14, milk:12 } },
  { cat:"デザート", id:"coffee_jelly", name:"はやおきコーヒーゼリー", ingredients: { coffee:16, milk:14, honey:12 } },
  { cat:"デザート", id:"popcorn", name:"だいばくはつポップコーン", ingredients: { corn:15, oil:14, milk:7 } },
  { cat:"デザート", id:"donut", name:"ちからもちソイドーナッツ", ingredients: { oil:12, soy:16, cacao:7 } },
  { cat:"デザート", id:"tea", name:"ネロリのデトックスティー", ingredients: { ginger:11, apple:15, mushroom:9 } },
  { cat:"デザート", id:"cookie", name:"ふくつのジンジャークッキー", ingredients: { honey:14, ginger:12, cacao:5, egg:4 } },
  { cat:"デザート", id:"fruit_ore", name:"あくまのキッスフルーツオレ", ingredients: { apple:11, milk:9, honey:7, cacao:8 } },
  { cat:"デザート", id:"choco_cake", name:"あまいかおりチョコケーキ", ingredients: { honey:9, cacao:8, milk:7 } },
  { cat:"デザート", id:"choco_tart", name:"はなびらのまいチョコタルト", ingredients: { cacao:11, apple:11 } },
  { cat:"デザート", id:"protein_smoothie", name:"はりきりプロテインスムージー", ingredients: { soy:15, cacao:8 } },
  { cat:"デザート", id:"malasada", name:"おおきいマラサダ", ingredients: { oil:10, milk:7, honey:6 } },
  { cat:"デザート", id:"soy_cake", name:"かるわざソイケーキ", ingredients: { egg:8, soy:7 } },
  { cat:"デザート", id:"veg_juice", name:"マイペースやさいジュース", ingredients: { tomato:9, apple:7 } },
  { cat:"デザート", id:"ginger_tea", name:"ひのこのジンジャーティー", ingredients: { ginger:9, apple:7 } },
  { cat:"デザート", id:"sweet_potato", name:"じゅくせいスイートポテト", ingredients: { potato:9, milk:5 } },
  { cat:"デザート", id:"apple_pie", name:"ねがいごとアップルパイ", ingredients: { apple:12, milk:4 } }
];

const el = (id) => document.getElementById(id);
let state = { recipeRows: [] };

function getIng(id) { return INGREDIENTS.find(x => x.id === id); }
function imgSrc(file) { return "images/" + encodeURIComponent(file); }

function renderGrids() {
  const ex = el("excludeGrid"), rep = el("replenishGrid");
  ex.innerHTML = ""; rep.innerHTML = "";
  INGREDIENTS.forEach(ing => {
    ex.innerHTML += `
      <div class="tile">
        <div class="tileName">${ing.name}</div>
        <img class="icon" src="${imgSrc(ing.file)}">
        <label class="chkLabel"><input type="checkbox" class="exChk" data-iid="${ing.id}">除外</label>
      </div>`;
    rep.innerHTML += `
      <div class="tile">
        <div class="tileName">${ing.name}</div>
        <img class="icon" src="${imgSrc(ing.file)}">
        <div class="repInputRow">
          <input type="number" class="repQty" data-iid="${ing.id}" placeholder="0" max="9999">
          <span class="suffix">個</span>
        </div>
      </div>`;
  });
document.querySelectorAll(".exChk, .repQty").forEach(input => {
  input.oninput = (e) => {
    // 9999上限チェック
    if (e.target.classList.contains("repQty")) {
      if (e.target.value > 9999) e.target.value = 9999;
      if (e.target.value < 0) e.target.value = 0; // 負数を防ぐ
    }
    calc();
  };
});
}

function addRecipeRow(init) {
  if (state.recipeRows.length >= MAX_RECIPE_ROWS) return;

  const rowId = crypto.randomUUID();
  const rowData = { rowId, cat: init?.cat || "カレー", recipeId: init?.recipeId || RECIPES[0].id, meals: init?.meals || 0 };
  state.recipeRows.push(rowData);

  const wrap = document.createElement("div");
  wrap.className = "recipeRow";
  wrap.dataset.rowId = rowId;
  wrap.innerHTML = `
    <button class="removeBtn">×</button>
    <div style="width:90px;"><label>カテゴリ</label><select class="catSel"><option>カレー</option><option>サラダ</option><option>デザート</option></select></div>
    <div style="flex:1; min-width:120px;"><label>料理</label><select class="recipeSel"></select></div>
    <div style="width:70px;"><label>食数</label><select class="mealsSel"></select></div>
    <div class="preview" style="width:100%;"></div>`;

  const cSel = wrap.querySelector(".catSel"), rSel = wrap.querySelector(".recipeSel"), mSel = wrap.querySelector(".mealsSel"), pre = wrap.querySelector(".preview");
  
  const updateRecipeList = () => {
    const filtered = RECIPES.filter(r => r.cat === cSel.value);
    rSel.innerHTML = filtered.map(r => `<option value="${r.id}">${r.name}</option>`).join("");
    if (filtered.some(r => r.id === rowData.recipeId)) rSel.value = rowData.recipeId;
    updatePreview();
  };

  const updatePreview = () => {
    rowData.cat = cSel.value; rowData.recipeId = rSel.value; rowData.meals = Number(mSel.value);
    const r = RECIPES.find(x => x.id === rSel.value);
    if (r) {
      pre.innerHTML = Object.entries(r.ingredients).map(([id, q]) => `<span><img src="${imgSrc(getIng(id).file)}" style="width:14px; margin-right:4px;">${q}</span>`).join("");
    }
    updateAllMealDropdowns();
    calc();
  };

  cSel.onchange = updateRecipeList;
  rSel.onchange = updatePreview;
  mSel.onchange = updatePreview;
  wrap.querySelector(".removeBtn").onclick = () => {
    state.recipeRows = state.recipeRows.filter(r => r.rowId !== rowId);
    wrap.remove();
    updateAllMealDropdowns();
    checkAddButton();
    calc();
  };

  cSel.value = rowData.cat;
  updateRecipeList();
  
  el("recipeList").appendChild(wrap);
  updateAllMealDropdowns();
  checkAddButton();
}

function updateAllMealDropdowns() {
  const currentTotal = state.recipeRows.reduce((sum, r) => sum + r.meals, 0);
  
  state.recipeRows.forEach(row => {
    const wrap = document.querySelector(`.recipeRow[data-row-id="${row.rowId}"]`);
    if (!wrap) return;
    const mSel = wrap.querySelector(".mealsSel");
    const otherMeals = currentTotal - row.meals;
    const maxAvailable = MAX_TOTAL_MEALS - otherMeals;
    
    const prevVal = mSel.value || row.meals;
    mSel.innerHTML = "";
    for (let i = 0; i <= maxAvailable; i++) {
      const opt = document.createElement("option");
      opt.value = i; opt.textContent = i;
      mSel.appendChild(opt);
    }
    mSel.value = Math.min(prevVal, maxAvailable);
    row.meals = Number(mSel.value);
  });
}

function checkAddButton() {
  el("addRecipe").disabled = state.recipeRows.length >= MAX_RECIPE_ROWS;
}

function calc() {
  const exclude = new Set([...document.querySelectorAll(".exChk:checked")].map(c => c.dataset.iid));
  const replenishMap = new Map([...document.querySelectorAll(".repQty")].map(c => [c.dataset.iid, Number(c.value) || 0]));

  const totalMeals = state.recipeRows.reduce((sum, r) => sum + r.meals, 0);
  const totalDays = totalMeals / MEALS_PER_DAY;
  el("summaryBadge").textContent = `合計 ${totalMeals}食`;

  const netNeed = new Map();
  state.recipeRows.forEach(row => {
    if (row.meals <= 0) return;
    const r = RECIPES.find(x => x.id === row.recipeId);
    if (!r) return;
    const rowDays = row.meals / MEALS_PER_DAY;
    Object.entries(r.ingredients).forEach(([iid, qtyPerMeal]) => {
      const gross = qtyPerMeal * row.meals;
      const rowReplenish = (replenishMap.get(iid) || 0) * rowDays;
      const currentNet = netNeed.get(iid) || 0;
      netNeed.set(iid, currentNet + (gross - rowReplenish));
    });
  });

  const resultGrid = el("resultGrid");
  resultGrid.innerHTML = "";
  let grandTotal = 0;

  const recipeOrder = [...new Set(state.recipeRows.filter(r => r.meals > 0).map(r => r.recipeId))];
  const ingredientOrder = [];
  recipeOrder.forEach(rid => {
    const r = RECIPES.find(x => x.id === rid);
    Object.keys(r.ingredients).forEach(iid => {
      if (!ingredientOrder.includes(iid)) ingredientOrder.push(iid);
    });
  });

  ingredientOrder.forEach(iid => {
    const ing = getIng(iid);
    if (!ing || exclude.has(iid)) return;
    const finalNeed = Math.max(0, Math.ceil(netNeed.get(iid) || 0));
    if (finalNeed > 0) {
      grandTotal += finalNeed;
      resultGrid.innerHTML += `
        <div class="tile">
          <div class="tileName">${ing.name}</div>
          <img class="icon" src="${imgSrc(ing.file)}">
          <div class="resultQty" style="font-weight:900;">${finalNeed}<span class="suffix">個</span></div>
        </div>`;
    }
  });
  el("totalBadge").textContent = `総合計 ${grandTotal}個`;
}

el("addRecipe").onclick = () => addRecipeRow({meals: 0});

// 修正：クリアボタンですべてリセットする処理
el("clearAll").onclick = () => { 
  // 1. レシピリストを空にする
  el("recipeList").innerHTML = ""; 
  state.recipeRows = []; 
  
  // 2. 除外チェックボックスをすべて外す
  document.querySelectorAll(".exChk").forEach(chk => chk.checked = false);
  
  // 3. 補完量の入力をすべて空（0）にする
  document.querySelectorAll(".repQty").forEach(input => input.value = "");
  
  // 4. 各種バッジと計算結果のリセット
  checkAddButton();
  calc(); 
  
  // 5. 初期状態として1行追加
  addRecipeRow({ cat: "カレー", recipeId: "avocado_gratin", meals: 0 });
};

renderGrids();
addRecipeRow({ cat: "カレー", recipeId: "avocado_gratin", meals: 0 });
</script>
</body>
</html>
