<!doctype html>
<html lang="ja">
<head>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#111111">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ¥é€±ã®é£Ÿæã‚¹ãƒˆãƒƒã‚¯è¨ˆç®—</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#666; --line:#e6e8f0; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; background:var(--bg); color:var(--text); }
    header { padding:14px 16px; font-weight:800; background:#111; color:#fff; position:sticky; top:0; z-index:5; }
    main { max-width: 980px; margin: 0 auto; padding: 12px; display:flex; flex-direction:column; gap: 12px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label { font-size: 13px; color: var(--muted); }
    select, input[type="number"], input[type="text"] {
      padding:10px 10px; border:1px solid var(--line); border-radius:12px; font-size:14px; background:#fff;
    }
    button {
      padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff; font-weight:700; cursor:pointer;
    }
    button.primary { background:#111; color:#fff; border-color:#111; }
    button.danger { background:#fff; color:#b00020; border-color:#f0c2c7; }
    .small { font-size:12px; color:var(--muted); }
    .divider { height:1px; background:var(--line); margin:10px 0; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
    .ing { display:flex; justify-content:space-between; gap:10px; padding:10px; border:1px solid var(--line); border-radius:12px; background:#fff; }
    .ing .left { display:flex; gap:8px; align-items:center; }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
    .qty { font-weight:800; }
    .recipeRow { border:1px dashed var(--line); border-radius:14px; padding:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .recipeRow > * { flex: 0 0 auto; }
    .recipeRow select { min-width: 240px; }
    .rightGrow { flex: 1 1 auto; }
  </style>
</head>
  <script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js");
}
  </script>

<body>
<header>æ¥é€±ã®é£Ÿæã‚¹ãƒˆãƒƒã‚¯è¨ˆç®—</header>

<main>
  <section class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div style="font-weight:800; font-size:16px;">æ¡ä»¶</div>
        <div class="small">ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã³ã€æ–™ç†ã¨é£Ÿæ•°ã‚’å…¥ã‚Œã‚‹ã¨å¿…è¦ã‚¹ãƒˆãƒƒã‚¯ã‚’è¨ˆç®—ã—ã¾ã™ï¼ˆé€±=7æ—¥ã§è¨ˆç®—ï¼‰ã€‚</div>
      </div>
      <div class="row">
        <label>é€±ã®æ—¥æ•°</label>
        <input id="days" type="number" min="1" max="30" value="7" style="width:90px;">
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div>
        <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆè¤‡æ•°å¯ï¼‰</label><br>
        <select id="categories" multiple size="3">
          <option value="curry">ã‚«ãƒ¬ãƒ¼ãƒ»ã‚·ãƒãƒ¥ãƒ¼</option>
          <option value="salad">ã‚µãƒ©ãƒ€</option>
          <option value="dessert">ãƒ‡ã‚¶ãƒ¼ãƒˆãƒ»ãƒ‰ãƒªãƒ³ã‚¯</option>
        </select>
        <div class="small">Ctrl/âŒ˜ã§è¤‡æ•°é¸æŠï¼ˆã‚¹ãƒãƒ›ã¯ã‚¿ãƒƒãƒ—ã§åˆ‡æ›¿ï¼‰</div>
      </div>

      <div class="rightGrow"></div>

      <button id="addRecipe" class="primary">æ–™ç†ã‚’è¿½åŠ </button>
      <button id="clearAll" class="danger">å…¨éƒ¨ã‚¯ãƒªã‚¢</button>
    </div>

    <div style="margin-top:10px;" id="recipeList"></div>
  </section>

  <section class="card">
    <div style="font-weight:800; font-size:16px;">ä»¥ä¸‹ã®é£Ÿæã¯è¨ˆç®—ã‹ã‚‰é™¤å¤–ã™ã‚‹</div>
    <div class="small">ãƒã‚§ãƒƒã‚¯ã—ãŸé£Ÿæã¯çµæœã‹ã‚‰0æ‰±ã„ï¼ˆâ€œç”¨æ„ã—ãªã„/åˆ¥æ‰‹æ®µã§è³„ã†â€æƒ³å®šï¼‰</div>
    <div class="grid" id="excludeGrid"></div>
  </section>

  <section class="card">
    <div style="font-weight:800; font-size:16px;">ä»¥ä¸‹ã®é£Ÿæã¯1æ—¥å½“ãŸã‚Šâ˜†å€‹è£œå®Œå¯èƒ½ã¨ä»®å®šã™ã‚‹</div>
    <div class="small">å„é£Ÿæã«ã€Œ1æ—¥ã‚ãŸã‚Šè£œå®Œã§ãã‚‹å€‹æ•°ã€ã‚’å…¥ã‚Œã‚‹ã¨ã€é€±åˆè¨ˆã‹ã‚‰ï¼ˆâ˜†Ã—æ—¥æ•°ï¼‰ã‚’æ¸›ç®—ã—ã¾ã™</div>
    <div class="grid" id="replenishGrid"></div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-end;">
      <div>
        <div style="font-weight:800; font-size:16px;">è¨ˆç®—çµæœ</div>
        <div class="small">è¡¨ç¤ºã¯ã€Œå¿…è¦ã‚¹ãƒˆãƒƒã‚¯æ•°ï¼ˆæ¸›ç®—å¾Œï¼‰ã€ã€‚ãƒã‚¤ãƒŠã‚¹ã«ãªã£ãŸã‚‰0ã«ä¸¸ã‚ã¾ã™ã€‚</div>
      </div>
      <button id="calc" class="primary">è¨ˆç®—ã™ã‚‹</button>
    </div>

    <div class="divider"></div>
    <div id="resultGrid" class="grid"></div>
  </section>
</main>

<script>
/**
 * é‡è¦ï¼š
 * - ãƒ¬ã‚·ãƒ”/é£Ÿæãƒ‡ãƒ¼ã‚¿ã¯ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚å¢—ã‚„ã™å ´åˆã¯ INGREDIENTS / RECIPES ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
 * - â€œ1æ—¥ã‚ãŸã‚Šè£œå®Œâ€ã¯ï¼ˆâ˜†Ã—æ—¥æ•°ï¼‰ã§å¼•ãä»•æ§˜ï¼ˆå¿…è¦ãªã‚‰â€œ1é£Ÿã‚ãŸã‚Šâ€ã«å¤‰æ›´ã§ãã¾ã™ï¼‰
 */

const INGREDIENTS = [
  {id:"apple", name:"ã¨ãã›ã‚“ãƒªãƒ³ã‚´", icon:"ğŸ"},
  {id:"honey", name:"ã‚ã¾ã„ãƒŸãƒ„", icon:"ğŸ¯"},
  {id:"milk", name:"ãƒ¢ãƒ¼ãƒ¢ãƒ¼ãƒŸãƒ«ã‚¯", icon:"ğŸ¥›"},
  {id:"oil", name:"ãƒ”ãƒ¥ã‚¢ãªã‚ªã‚¤ãƒ«", icon:"ğŸ›¢ï¸"},
  {id:"potato", name:"ã»ã£ã“ã‚Šãƒãƒ†ãƒˆ", icon:"ğŸ¥”"},
  {id:"avocado", name:"ã¤ã‚„ã¤ã‚„ã‚¢ãƒœã‚«ãƒ‰", icon:"ğŸ¥‘"},
  {id:"tomato", name:"ã‚ã‚“ã¿ã‚“ãƒˆãƒãƒˆ", icon:"ğŸ…"},
  {id:"ginger", name:"ã²ã‚“ã‚„ã‚Šã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼", icon:"ğŸ«š"},
  {id:"corn", name:"ãƒ¯ã‚«ã‚¯ã‚µã‚³ãƒ¼ãƒ³", icon:"ğŸŒ½"},
  {id:"cacao", name:"ãƒªãƒ©ãƒƒã‚¯ã‚¹ã‚«ã‚«ã‚ª", icon:"ğŸ«"},
  {id:"egg", name:"ã¨ãã›ã‚“ã‚¨ãƒƒã‚°", icon:"ğŸ¥š"},
  {id:"soy", name:"ãƒãƒ¡ãƒŸãƒ¼ãƒˆ", icon:"ğŸ«˜"},
  {id:"mushroom", name:"ã‚ã˜ã‚ã„ã‚­ãƒã‚³", icon:"ğŸ„"},
  {id:"leek", name:"ãµã¨ã„ãªãŒã­ã", icon:"ğŸ§…"},
  {id:"meat", name:"ã’ã‚“ãã‚½ãƒ¼ã‚»ãƒ¼ã‚¸", icon:"ğŸŒ­"},
  {id:"bean", name:"ãƒ¯ã‚«ã‚¯ã‚µå¤§è±†", icon:"ğŸ«˜"},
  {id:"herb", name:"ã‚ã–ã¾ã—ãƒãƒ¼ãƒ–", icon:"ğŸŒ¿"},
  {id:"tails", name:"ãŠãŠãã„ã—ã£ã½", icon:"ğŸŸ"},
  {id:"coffee", name:"ã‚¹ãƒ‘ãƒ¼ã‚¯ã‚¹ã‚³ãƒ¼ãƒ’ãƒ¼", icon:"â˜•"},
];

// ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ã‚·ãƒ”ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¢—ã‚„ã—ã¦ãã ã•ã„ï¼‰
const RECIPES = [
  {
    id:"shiny_avocado_gratin",
    category:"curry",
    name:"ã—ã‚“ã‚Šã‚‡ãã‚¢ãƒœã‚«ãƒ‰ã‚°ãƒ©ã‚¿ãƒ³",
    ingredients: { avocado:22, potato:20, milk:41, oil:32 }
  },
  {
    id:"simple_curry",
    category:"curry",
    name:"ã‚·ãƒ³ãƒ—ãƒ«ã‚«ãƒ¬ãƒ¼ï¼ˆä¾‹ï¼‰",
    ingredients: { tomato:10, oil:8, meat:12 }
  },
  {
    id:"potato_salad",
    category:"salad",
    name:"ãƒãƒ†ãƒˆã‚µãƒ©ãƒ€ï¼ˆä¾‹ï¼‰",
    ingredients: { potato:18, egg:10, oil:6 }
  },
  {
    id:"honey_yogurt",
    category:"dessert",
    name:"ã¯ã¡ã¿ã¤ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆä¾‹ï¼‰",
    ingredients: { honey:16, milk:14, cacao:6 }
  }
];

const el = (id) => document.getElementById(id);

const state = {
  recipeRows: [] // {rowId, recipeId, meals}
};

function selectedCategories() {
  const sel = Array.from(el("categories").selectedOptions).map(o => o.value);
  return sel.length ? sel : ["curry","salad","dessert"];
}

function recipeOptionsHTML() {
  const cats = new Set(selectedCategories());
  const filtered = RECIPES.filter(r => cats.has(r.category));
  const groups = {
    curry: filtered.filter(r => r.category==="curry"),
    salad: filtered.filter(r => r.category==="salad"),
    dessert: filtered.filter(r => r.category==="dessert")
  };
  const catLabel = {curry:"ã‚«ãƒ¬ãƒ¼ãƒ»ã‚·ãƒãƒ¥ãƒ¼", salad:"ã‚µãƒ©ãƒ€", dessert:"ãƒ‡ã‚¶ãƒ¼ãƒˆãƒ»ãƒ‰ãƒªãƒ³ã‚¯"};
  let html = `<option value="">æ–™ç†ã‚’é¸æŠâ€¦</option>`;
  for (const cat of ["curry","salad","dessert"]) {
    if (!groups[cat].length) continue;
    html += `<optgroup label="${catLabel[cat]}">`;
    for (const r of groups[cat]) html += `<option value="${r.id}">${r.name}</option>`;
    html += `</optgroup>`;
  }
  return html;
}

function addRecipeRow(initial={recipeId:"", meals:1}) {
  const rowId = crypto.randomUUID();
  state.recipeRows.push({rowId, ...initial});

  const wrap = document.createElement("div");
  wrap.className = "recipeRow";
  wrap.dataset.rowId = rowId;

  wrap.innerHTML = `
    <div>
      <label>æ–™ç†</label><br>
      <select class="recipeSel">${recipeOptionsHTML()}</select>
    </div>

    <div>
      <label>ä½•é£Ÿä½œã‚Šã¾ã™ã‹ï¼Ÿ</label><br>
      <select class="mealsSel">
        ${Array.from({length:21}, (_,i)=>`<option value="${i+1}">${i+1}</option>`).join("")}
      </select>
      <span class="pill">é£Ÿ</span>
    </div>

    <div class="rightGrow small" style="min-width:220px;">
      <span class="preview"></span>
    </div>

    <button class="removeBtn danger">å‰Šé™¤</button>
  `;

  const recipeSel = wrap.querySelector(".recipeSel");
  const mealsSel = wrap.querySelector(".mealsSel");
  const preview = wrap.querySelector(".preview");

  recipeSel.value = initial.recipeId || "";
  mealsSel.value = String(initial.meals ?? 1);

  function renderPreview() {
    const rid = recipeSel.value;
    const r = RECIPES.find(x => x.id === rid);
    if (!r) { preview.textContent = ""; return; }
    const parts = Object.entries(r.ingredients).map(([iid, q]) => {
      const ing = INGREDIENTS.find(i=>i.id===iid);
      return `${ing?.icon ?? "â– "}${q}`;
    });
    preview.textContent = `ææ–™: ${parts.join(" / ")}`;
  }
  renderPreview();

  recipeSel.addEventListener("change", () => {
    const s = state.recipeRows.find(x => x.rowId === rowId);
    s.recipeId = recipeSel.value;
    renderPreview();
  });

  mealsSel.addEventListener("change", () => {
    const s = state.recipeRows.find(x => x.rowId === rowId);
    s.meals = Number(mealsSel.value);
    renderPreview();
  });

  wrap.querySelector(".removeBtn").addEventListener("click", () => {
    state.recipeRows = state.recipeRows.filter(x => x.rowId !== rowId);
    wrap.remove();
  });

  el("recipeList").appendChild(wrap);
}

function renderExcludeAndReplenish() {
  const ex = el("excludeGrid");
  const rep = el("replenishGrid");
  ex.innerHTML = "";
  rep.innerHTML = "";

  for (const ing of INGREDIENTS) {
    // exclude
    const exItem = document.createElement("div");
    exItem.className = "ing";
    exItem.innerHTML = `
      <div class="left">
        <input type="checkbox" class="exChk" data-iid="${ing.id}">
        <div>
          <div>${ing.icon} ${ing.name}</div>
          <div class="small">${ing.id}</div>
        </div>
      </div>
      <div class="pill">é™¤å¤–</div>
    `;
    ex.appendChild(exItem);

    // replenish
    const repItem = document.createElement("div");
    repItem.className = "ing";
    repItem.innerHTML = `
      <div class="left">
        <input type="checkbox" class="repChk" data-iid="${ing.id}">
        <div>
          <div>${ing.icon} ${ing.name}</div>
          <div class="small">1æ—¥ã‚ãŸã‚Š</div>
        </div>
      </div>
      <div class="row" style="gap:6px;">
        <input type="number" class="repQty" data-iid="${ing.id}" min="0" max="999" value="0" style="width:90px;">
        <span class="pill">å€‹</span>
      </div>
    `;
    rep.appendChild(repItem);
  }
}

function readExcludeSet() {
  const set = new Set();
  document.querySelectorAll(".exChk:checked").forEach(chk => set.add(chk.dataset.iid));
  return set;
}

function readReplenishMap() {
  const map = new Map(); // iid -> perDay
  document.querySelectorAll(".repChk:checked").forEach(chk => {
    const iid = chk.dataset.iid;
    const qtyInput = document.querySelector(`.repQty[data-iid="${iid}"]`);
    const perDay = Math.max(0, Math.min(999, Number(qtyInput.value || 0)));
    map.set(iid, perDay);
  });
  return map;
}

function calc() {
  const days = Math.max(1, Math.min(30, Number(el("days").value || 7)));
  const exclude = readExcludeSet();
  const replenish = readReplenishMap();

  // åˆè¨ˆå¿…è¦æ•°ï¼ˆæ¸›ç®—å‰ï¼‰
  const need = new Map(); // iid -> total needed
  for (const row of state.recipeRows) {
    if (!row.recipeId) continue;
    const recipe = RECIPES.find(r => r.id === row.recipeId);
    if (!recipe) continue;
    const meals = Math.max(1, Math.min(21, Number(row.meals || 1)));
    for (const [iid, perMeal] of Object.entries(recipe.ingredients)) {
      const prev = need.get(iid) || 0;
      need.set(iid, prev + perMeal * meals);
    }
  }

  // é™¤å¤–
  for (const iid of exclude) need.set(iid, 0);

  // è£œå®Œï¼ˆâ˜†Ã—æ—¥æ•° ã‚’å¼•ãï¼‰
  for (const [iid, perDay] of replenish.entries()) {
    const prev = need.get(iid) || 0;
    const next = prev - perDay * days;
    need.set(iid, Math.max(0, next));
  }

  // çµæœè¡¨ç¤ºï¼ˆå¿…è¦æ•°ãŒå¤šã„é †ï¼‰
  const list = INGREDIENTS.map(ing => ({
    ...ing,
    total: need.get(ing.id) || 0
  })).filter(x => x.total > 0).sort((a,b) => b.total - a.total);

  const out = el("resultGrid");
  out.innerHTML = "";
  if (!list.length) {
    out.innerHTML = `<div class="small">çµæœãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆæ–™ç†ãŒæœªé¸æŠã€ã¾ãŸã¯å…¨ã¦é™¤å¤–/è£œå®Œã§0ã«ãªã‚Šã¾ã—ãŸï¼‰</div>`;
    return;
  }

  for (const x of list) {
    const item = document.createElement("div");
    item.className = "ing";
    item.innerHTML = `
      <div class="left">
        <div style="font-size:22px;">${x.icon}</div>
        <div>
          <div>${x.name}</div>
          <div class="small">${x.id}</div>
        </div>
      </div>
      <div class="qty">${x.total}å€‹</div>
    `;
    out.appendChild(item);
  }
}

function refreshRecipeSelects() {
  document.querySelectorAll(".recipeSel").forEach(sel => {
    const current = sel.value;
    sel.innerHTML = recipeOptionsHTML();
    sel.value = current; // å¯èƒ½ãªã‚‰å¾©å…ƒ
  });
}

el("addRecipe").addEventListener("click", () => addRecipeRow({recipeId:"", meals:1}));
el("clearAll").addEventListener("click", () => {
  state.recipeRows = [];
  el("recipeList").innerHTML = "";
  el("resultGrid").innerHTML = "";
  // ãƒã‚§ãƒƒã‚¯é¡ã‚‚æˆ»ã™
  document.querySelectorAll("input[type=checkbox]").forEach(x => x.checked = false);
  document.querySelectorAll(".repQty").forEach(x => x.value = "0");
});
el("calc").addEventListener("click", calc);
el("categories").addEventListener("change", refreshRecipeSelects);

// init
renderExcludeAndReplenish();
addRecipeRow({recipeId:"shiny_avocado_gratin", meals:21});
</script>
</body>
</html>
