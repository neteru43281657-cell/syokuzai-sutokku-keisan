<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>食材ストック計算</title>
  <style>
    :root { --bg: #f6f7fb; --card: #fff; --text: #111; --muted: #666; --line: #e6e8f0; --danger: #b00020; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.4; }
    header { padding: 12px 14px; font-weight: 800; background: #111; color: #fff; position: sticky; top: 0; z-index: 5; }
    main { max-width: 980px; margin: 0 auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .grid4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    label { font-size: 11px; color: var(--muted); display: block; margin-bottom: 2px; }
    select, input[type="number"] { padding: 6px; border: 1px solid var(--line); border-radius: 10px; font-size: 14px; width: 100%; background: #fff; }
    button { padding: 8px 12px; border: 1px solid var(--line); border-radius: 10px; background: #fff; font-weight: 800; cursor: pointer; font-size: 13px; }
    button.primary { background: #111; color: #fff; }
    button.danger { color: var(--danger); border-color: #f0c2c7; }
    .badge { font-size: 11px; padding: 3px 8px; border-radius: 999px; border: 1px solid var(--line); color: var(--muted); background: #fff; }
    .divider { height: 1px; background: var(--line); margin: 8px 0; }
    .tile { border: 1px solid var(--line); border-radius: 10px; padding: 6px; display: flex; flex-direction: column; gap: 4px; background: #fff; align-items: center; text-align: center; }
    .icon { width: 32px; height: 32px; object-fit: contain; }
    .tileName { font-size: 10px; font-weight: 800; height: 2.4em; display: flex; align-items: center; justify-content: center; line-height: 1.2; }
    .recipeRow { border: 1px dashed var(--line); border-radius: 12px; padding: 10px; display: flex; gap: 8px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 8px; }
    .preview { font-size: 11px; display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; border-top: 1px solid #f0f1f5; padding-top: 6px; }
    .preview span { display: flex; align-items: center; background: #f0f1f5; padding: 2px 6px; border-radius: 6px; }
    @media (max-width: 360px) { .grid4 { gap: 4px; } }
  </style>
</head>
<body>

<header>食材ストック計算</header>

<main>
  <section class="card">
    <div class="row" style="justify-content: space-between;">
      <div style="font-weight:900; font-size:14px;">条件設定 <span class="badge" id="summaryBadge">合計 0食</span></div>
      <div class="row">
        <button id="addRecipe" class="primary">+ 追加</button>
        <button id="clearAll" class="danger">クリア</button>
      </div>
    </div>
    <div id="recipeList" style="margin-top:8px;"></div>
  </section>

  <section class="card">
    <div style="font-weight:900; font-size:13px; margin-bottom:8px;">1日当たりの補完量</div>
    <div id="replenishGrid" class="grid4"></div>
  </section>

  <section class="card">
    <div class="row" style="justify-content: space-between;">
      <div style="font-weight:900; font-size:14px;">計算結果（ストック必要数）</div>
      <span class="badge" id="totalBadge" style="color:#111; font-weight:800;">総合計 0個</span>
    </div>
    <div class="divider"></div>
    <div id="resultGrid" class="grid4"></div>
  </section>
</main>

<script>
const MEALS_PER_DAY = 3;
// 検索を高速化するためオブジェクト形式に変更
const ING_DATA = {
  apple: { name:"とくせんリンゴ", file:"とくせんリンゴ.webp" },
  mushroom: { name:"あじわいキノコ", file:"あじわいキノコ.webp" },
  ginger: { name:"あったかジンジャー", file:"あったかジンジャー.webp" },
  honey: { name:"あまいミツ", file:"あまいミツ.webp" },
  tomato: { name:"あんみんトマト", file:"あんみんトマト.webp" },
  tail: { name:"おいしいシッポ", file:"おいしいシッポ.webp" },
  herb: { name:"げきからハーブ", file:"げきからハーブ.webp" },
  pumpkin: { name:"ずっしりカボチャ", file:"ずっしりカボチャ.webp" },
  avocado: { name:"つやつやアボカド", file:"つやつやアボカド.webp" },
  egg: { name:"とくせんエッグ", file:"とくせんエッグ.webp" },
  oil: { name:"ピュアなオイル", file:"ピュアなオイル.webp" },
  leek: { name:"ふといながねぎ", file:"ふといながねぎ.webp" },
  potato: { name:"ほっこりポテト", file:"ほっこりポテト.webp" },
  soymeat: { name:"マメミート", file:"マメミート.webp" },
  coffee: { name:"めざましコーヒー", file:"めざましコーヒー.webp" },
  milk: { name:"モーモーミルク", file:"モーモーミルク.webp" },
  cacao: { name:"リラックスカカオ", file:"リラックスカカオ.webp" },
  corn: { name:"ワカクサコーン", file:"ワカクサコーン.webp" },
  soy: { name:"ワカクサ大豆", file:"ワカクサ大豆.webp" }
};

const RECIPES = [
  { cat:"カレー", id:"avocado_gratin", name:"しんりょくアボカドグラタン", ingredients: { avocado:22, potato:20, milk:41, oil:32 } },
  { cat:"カレー", id:"sukiyaki_curry", name:"いあいぎりすき焼きカレー", ingredients: { leek:27, soymeat:26, honey:26, egg:22 } },
  { cat:"カレー", id:"awake_stew", name:"めざめるパワーシチュー", ingredients: { soy:28, tomato:25, mushroom:23, coffee:16 } },
  { cat:"カレー", id:"pumpkaboo_stew", name:"なりきりバケッチャシチュー", ingredients: { pumpkin:10, soymeat:16, potato:18, mushroom:25 } },
  { cat:"カレー", id:"ninja_curry", name:"ニンジャカレー", ingredients: { soy:24, soymeat:9, leek:12, mushroom:5 } },
  { cat:"カレー", id:"butter_curry", name:"ぜったいねむりバターカレー", ingredients: { potato:18, tomato:15, cacao:12, milk:10 } },
  { cat:"カレー", id:"tail_curry", name:"あぶりテールカレー", ingredients: { tail:8, herb:25 } },
  { cat:"サラダ", id:"guacamole_chips", name:"じならしワカモレチップス", ingredients: { avocado:28, corn:25, herb:30, soy:22 } },
  { cat:"デザート", id:"pancake", name:"ドキドキこわいかおパンケーキ", ingredients: { pumpkin:18, egg:24, honey:32, tomato:29 } }
];

let rows = []; 
const $ = (id) => document.getElementById(id);

function init() {
  // 補完量グリッドの生成
  $("replenishGrid").innerHTML = Object.entries(ING_DATA).map(([id, ing]) => `
    <div class="tile">
      <div class="tileName">${ing.name}</div>
      <img class="icon" src="images/${ing.file}">
      <div class="row" style="margin-top:2px;">
        <input type="number" class="repQty" data-iid="${id}" placeholder="0" style="padding:2px 4px; font-size:12px; text-align:center;">
        <span style="font-size:10px;">/日</span>
      </div>
    </div>`).join("");
  
  $("replenishGrid").oninput = calc;
  $("addRecipe").onclick = () => addRecipeRow();
  $("clearAll").onclick = () => { $("recipeList").innerHTML = ""; rows = []; calc(); };
  
  addRecipeRow();
}

function addRecipeRow() {
  const rowId = crypto.randomUUID();
  const wrap = document.createElement("div");
  wrap.className = "recipeRow";
  wrap.innerHTML = `
    <div style="width:90px;"><label>カテゴリ</label><select class="catSel"><option>カレー</option><option>サラダ</option><option>デザート</option></select></div>
    <div style="flex:1;"><label>料理</label><select class="recipeSel"></select></div>
    <div style="width:70px;"><label>食数</label><input type="number" class="mealsInput" value="0" min="0"></div>
    <div class="preview" style="width:100%;"></div>`;

  const [cSel, rSel, mInp, pre] = wrap.querySelectorAll("select, input, .preview");
  const rowData = { id: rowId, cSel, rSel, mInp, pre };
  rows.push(rowData);

  const syncOptions = () => {
    const filtered = RECIPES.filter(r => r.cat === cSel.value);
    rSel.innerHTML = filtered.map(r => `<option value="${r.id}">${r.name}</option>`).join("");
    updatePreview();
  };

  const updatePreview = () => {
    const r = RECIPES.find(x => x.id === rSel.value);
    pre.innerHTML = r ? Object.entries(r.ingredients).map(([id, q]) => 
      `<span><img src="images/${ING_DATA[id].file}" style="width:14px; margin-right:4px;">${q}</span>`).join("") : "";
    calc();
  };

  cSel.onchange = syncOptions;
  rSel.onchange = updatePreview;
  mInp.oninput = calc;
  
  syncOptions();
  $("recipeList").appendChild(wrap);
}

function calc() {
  const reps = Object.fromEntries([...document.querySelectorAll(".repQty")].map(i => [i.dataset.iid, Number(i.value) || 0]));
  const totalMeals = rows.reduce((s, r) => s + Number(r.mInp.value), 0);
  const days = totalMeals / MEALS_PER_DAY;
  
  $("summaryBadge").textContent = `合計 ${totalMeals}食（${days.toFixed(1)}日分）`;

  const totals = {};
  const order = [];

  rows.forEach(row => {
    const qty = Number(row.mInp.value);
    if (qty <= 0) return;
    const r = RECIPES.find(x => x.id === row.rSel.value);
    Object.entries(r.ingredients).forEach(([id, q]) => {
      if (!(id in totals)) { totals[id] = 0; order.push(id); }
      totals[id] += (q * qty);
    });
  });

  let grandTotal = 0;
  const html = order.map(id => {
    const finalNeed = Math.max(0, Math.round(totals[id] - (reps[id] * days)));
    if (finalNeed <= 0) return "";
    grandTotal += finalNeed;
    return `
      <div class="tile">
        <div class="tileName">${ING_DATA[id].name}</div>
        <img class="icon" src="images/${ING_DATA[id].file}">
        <div style="font-weight:900;">${finalNeed}<span style="font-size:10px;">個</span></div>
      </div>`;
  }).join("");

  $("resultGrid").innerHTML = html;
  $("totalBadge").textContent = `総合計 ${grandTotal}個`;
}

init();
</script>
</body>
</html>
